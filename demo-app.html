<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MAESTRO ‚Ä¢ Prototype (Fiori-like, Light)</title>
  <style>
    :root{
      --bg:#ffffff;           /* light mode */
      --card:#ffffff;
      --muted:#4c637a;
      --text:#0b1a2b;
      --accent:#0a6ed1;       /* SAP Fiori blue */
      --accent-2:#0a6ed1;
      --warn:#e9730c;
      --danger:#bb0000;
      --ok:#107e3e;
      --border:#e5ebf2;
      --chip:#f5f8fb;
      --focus:#ffcc00;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .app{display:flex;flex-direction:column;min-height:100%}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.85));backdrop-filter: blur(6px);border-bottom:1px solid var(--border)}
    .topbar{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:.8rem 1rem}
    .brand{display:flex;gap:.6rem;align-items:center}
    .brand h1{margin:0;font-size:16px;font-weight:700;letter-spacing:.4px}
    .brand .chip{background:var(--chip);padding:.1rem .5rem;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .search{display:flex;gap:.5rem;align-items:center;max-width:560px;width:100%}
    .search input{flex:1;padding:.55rem .7rem;border-radius:.6rem;border:1px solid var(--border);background:#ffffff;color:var(--text)}
    .search button{padding:.55rem .8rem;border-radius:.6rem;border:1px solid var(--border);background:#f7fafe;color:var(--text);cursor:pointer}
    .toolbar{display:flex;gap:.5rem}
    .toolbar button{padding:.5rem .7rem;border-radius:.6rem;border:1px solid var(--border);background:#f7fafe;color:var(--text);cursor:pointer}

    nav.tabs{display:flex;gap:.25rem;padding:.4rem .5rem;border-bottom:1px solid var(--border)}
    nav.tabs button{padding:.55rem .8rem;border-radius:.6rem;border:1px solid transparent;background:transparent;color:var(--muted);cursor:pointer}
    nav.tabs button.active{color:var(--text);border-color:var(--border);background:#f7fafe}

    main{padding:1rem;display:flex;flex-direction:column;gap:1rem}

    .filters{display:flex;flex-wrap:wrap;gap:.5rem}
    .filters select,.filters input[type=date]{padding:.45rem .6rem;border-radius:.5rem;border:1px solid var(--border);background:#ffffff;color:var(--text)}

    .kpis{display:grid;grid-template-columns:repeat(4,minmax(180px,1fr));gap:.75rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:.9rem}
    .card h3{margin:.1rem 0 .4rem;font-size:13px;color:var(--muted);font-weight:600}
    .metric{display:flex;align-items:baseline;gap:.5rem}
    .metric .big{font-size:24px;font-weight:800}
    .trend.up{color:var(--ok)}
    .trend.down{color:var(--danger)}

    .grid-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
    .heatmap{border-collapse:collapse;width:max-content}
    .heatmap th, .heatmap td{white-space:nowrap;border:1px solid var(--border);padding:.35rem .45rem;text-align:center;font-variant-numeric:tabular-nums}
    .heatmap thead th{position:sticky;top:0;background:#f7fafe;color:var(--muted);font-size:12px}
    .heatmap tbody th{position:sticky;left:0;background:#f7fafe;color:var(--muted);text-align:left}
    .cell{min-width:34px}
    .occ-0{background:#f5f7fa}
    .occ-ok{background:linear-gradient(180deg,#dff7e8,#c9f0d8)}
    .occ-warn{background:linear-gradient(180deg,#fff5cc,#ffe49c)}
    .occ-bad{background:linear-gradient(180deg,#ffe0e0,#ffc6cc)}
    .cell a{display:block;color:#0a6ed1}

    .section{display:none}
    .section.active{display:block}

    .list{display:grid;gap:.5rem}
    table.data{border-collapse:collapse;width:100%}
    table.data th,table.data td{border-bottom:1px solid var(--border);padding:.5rem;text-align:left}
    table.data th{color:var(--muted);font-weight:600;font-size:12px}
    table.data tr:hover{background:#f7fbff}

    .badge{display:inline-block;padding:.1rem .45rem;border-radius:999px;border:1px solid var(--border);background:#f7fafe;color:var(--muted);font-size:11px}
    .row-actions{display:flex;gap:.35rem}

    .drawer{position:fixed;inset:0;display:none;align-items:stretch;justify-content:flex-end;background:rgba(0,0,0,.35)}
    .drawer.open{display:flex}
    .panel{width:min(560px,100%);background:var(--card);border-left:1px solid var(--border);padding:1rem;overflow:auto}
    .panel h2{margin-top:0}
    .form{display:grid;gap:.6rem}
    .form label{display:grid;gap:.25rem;font-size:12px;color:var(--muted)}
    .form input,.form select, .form textarea{padding:.5rem;border-radius:.5rem;border:1px solid var(--border);background:#ffffff;color:var(--text)}
    .form .row{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
    .panel .actions{display:flex;gap:.5rem;margin-top:.75rem}
    .btn{padding:.5rem .8rem;border-radius:.6rem;border:1px solid var(--border);background:#f7fafe;color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#0a6ed1,#085cab);border-color:#085cab;color:#fff}
    .btn.danger{background:linear-gradient(180deg,#b01a3a,#8e1730);border-color:#75142a;color:#fff}
    .btn.ghost{background:transparent}

    .tools{display:flex;gap:.5rem;flex-wrap:wrap}

    .pill{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .5rem;border-radius:999px;background:#f4f8fc;border:1px solid var(--border);color:var(--muted);font-size:12px}

    .help{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="topbar">
      <div class="brand">
        <span class="chip">MAESTRO</span>
        <h1>Maintenance moteurs ‚Äî Prototype</h1>
      </div>
      <div class="search" role="search">
        <input id="searchInput" placeholder="Rechercher par ID (ex: REQ-003 ou OP-014)"/>
        <button id="searchBtn">Rechercher</button>
      </div>
      <div class="toolbar">
        <button id="exportBtn" title="Exporter les donn√©es JSON">Exporter JSON</button>
        <label class="btn" title="Importer des donn√©es JSON">
          Importer JSON
          <input id="importInput" type="file" accept="application/json" hidden />
        </label>
        <button id="resetBtn" class="btn danger" title="R√©initialiser les donn√©es">Reset</button>
      </div>
    </div>
    <nav class="tabs" aria-label="Navigation">
      <button data-tab="dashboard" class="active">Dashboard</button>
      <button data-tab="requests">Requests</button>
      <button data-tab="operations">Operations</button>
      <button data-tab="master">Master Data</button>
      <button data-tab="tools">Outils</button>
    </nav>
  </header>

  <main>
    <!-- DASHBOARD -->
    <section id="tab-dashboard" class="section active" aria-labelledby="tab1">
      <div class="filters" id="filters"></div>

      <section class="kpis" id="kpis">
        <article class="card"><h3>Utilisation globale (8 sem)</h3><div class="metric"><div class="big" id="kpiUtil">‚Äì</div><div id="kpiUtilTrend" class="trend"></div></div></article>
        <article class="card"><h3>% urgences livr√©es √† l'heure</h3><div class="metric"><div class="big" id="kpiAOG">‚Äì</div></div></article>
        <article class="card"><h3>Backlog / Retards</h3><div class="metric"><div class="big" id="kpiBacklog">‚Äì</div></div></article>
        <article class="card"><h3>ETA moyen demandes actives</h3><div class="metric"><div class="big" id="kpiETA">‚Äì</div></div></article>
      </section>

      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.6rem">
          <h3 style="margin:0;color:var(--muted)">Heatmap d'occupation ‚Äî Shops √ó Jours (8 semaines)</h3>
          <div class="tools">
            <span class="pill">‚úÖ 0‚Äì85%</span>
            <span class="pill">‚ö†Ô∏è 85‚Äì100%</span>
            <span class="pill">üü• &gt;100%</span>
            <button id="gotoToday" class="btn ghost">Aller √† aujourd'hui</button>
          </div>
        </div>
        <div class="grid-wrap" id="heatWrap"><table id="heatmap" class="heatmap" aria-label="Heatmap"></table></div>
        <p class="help">Astuce¬†: clique une cellule pour ouvrir l'onglet <em>Operations</em> filtr√© (shop + jour).</p>
      </section>
    </section>

    <!-- REQUESTS -->
    <section id="tab-requests" class="section">
      <div class="list card">
        <table class="data" id="tblRequests">
          <thead><tr>
            <th>ID</th><th>Client</th><th>Moteur</th><th>Type</th><th>Urgence</th><th>Statut</th><th>Pays</th><th>Due</th><th>ETA</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- OPERATIONS -->
    <section id="tab-operations" class="section">
      <div class="list card">
        <div class="help">Filtre courant¬†: <span id="opFilterDesc">(aucun)</span></div>
        <table class="data" id="tblOps">
          <thead><tr>
            <th>ID</th><th>Request</th><th>Type</th><th>Shop</th><th>Date</th><th>Slots</th><th>Statut</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- MASTER DATA -->
    <section id="tab-master" class="section">
      <article class="card">
        <h3>Shops (10)</h3>
        <table class="data" id="tblShops"><thead><tr><th>ID</th><th>Ville</th><th>Pays</th><th>Slots/jour</th><th>Types autoris√©s</th></tr></thead><tbody></tbody></table>
      </article>
      <article class="card">
        <h3>Mappings & Dur√©es</h3>
        <div class="list">
          <div><strong>RequestType ‚Üí Ops</strong><div id="mapReq"></div></div>
          <div><strong>Dur√©es (slots)</strong><div id="mapDur"></div></div>
        </div>
      </article>
    </section>

    <!-- TOOLS -->
    <section id="tab-tools" class="section">
      <article class="card">
        <h3>Import / Export JSON</h3>
        <div class="tools">
          <button id="doExport" class="btn">Exporter</button>
          <label class="btn">Importer<input id="doImport" type="file" accept="application/json" hidden></label>
        </div>
      </article>
      <article class="card">
        <h3>R√©initialisation</h3>
        <button id="doReset" class="btn danger">Reset data (seed)</button>
      </article>
      <article class="card">
        <h3>Debug</h3>
        <button id="showJSON" class="btn">Voir JSON</button>
        <pre id="jsonOut" style="max-height:260px;overflow:auto;background:#f7fafc;border:1px solid var(--border);padding:.6rem;border-radius:10px"></pre>
      </article>
    </section>
  </main>
</div>

<!-- DRAWERS -->
<div id="drawer" class="drawer" aria-modal="true" role="dialog">
  <div class="panel" id="drawerPanel"></div>
</div>

<script>
(function(){
  const KEY = 'MAESTRO_STATE_V1';
  const todayISO = new Date().toISOString().slice(0,10);

  // ---------- STATE ----------
  const S = {
    mdLists:{}, mappings:{}, shops:[], requests:[], operations:[],
    ui:{
      tab:'dashboard',
      filters:{siteCountry:'', shopId:'', requestType:'', urgency:'', status:'', opType:''},
      opFilter:{shopId:'', date:''},
      days: generateDays(56), // 8 semaines
    }
  };

  // ---------- INIT ----------
  init();

  function init(){
    const saved = localStorage.getItem(KEY);
    if(saved){
      try{Object.assign(S, JSON.parse(saved));}catch{ }
      // ensure days are fresh from today
      S.ui.days = generateDays(56);
    } else {
      seedMasterData();
      seedShops();
      seedRequestsAndOps();
      persist();
    }

    renderTabs();
    renderFilters();
    bindHeader();

    renderAll();
  }

  function renderAll(){
    renderKPIs();
    renderHeatmap();
    renderRequests();
    renderOps();
    renderMaster();
  }

  // ---------- SEEDERS ----------
  function seedMasterData(){
    S.mdLists.clients = ['Air France','Lufthansa','Ryanaar','easyJet','Turkish Airlines','Qatar Airways','Emirates','American Airlines','Delta Air Lines','United Airlines'];
    S.mdLists.engineModels = ['CFM56','LEAP-1A','LEAP-1B','GE90','Trent 700'];
    S.mdLists.requestTypes = ['Overhaul','QuickInspection','DeepRepair'];
    S.mdLists.urgencies = ['Normal','AOG'];
    S.mdLists.statuses = ['Ouvert','Pr√™t','En cours','Termin√©'];
    S.mdLists.siteCountries = ['France','Allemagne','Espagne','Royaume-Uni','Italie'];
    S.mdLists.opTypes = ['Inspection','Disassembly','Repair','DeepRepair','Cleaning','Assembly','TestRun','NDT','Calibration','Balancing','Painting','Documentation'];

    S.mappings.requestTypeToOps = {
      'Overhaul':['Disassembly','Repair','Assembly','TestRun'],
      'QuickInspection':['Inspection','Cleaning','Assembly','TestRun'],
      'DeepRepair':['Disassembly','DeepRepair','Assembly','TestRun']
    };
    S.mappings.opDurations = {
      'Inspection':1,'Disassembly':2,'Repair':3,'DeepRepair':4,'Cleaning':1,'Assembly':2,'TestRun':2,'NDT':1,'Calibration':1,'Balancing':1,'Painting':2,'Documentation':1
    };
  }

  function seedShops(){
    const shops = [
      ['FR-LYO','Lyon','France',7,['Inspection','Cleaning','Assembly','Painting','Documentation']],
      ['FR-TLS','Toulouse','France',8,['Inspection','Disassembly','Repair','DeepRepair','Assembly','TestRun','NDT']],
      ['DE-HAM','Hambourg','Allemagne',8,['Inspection','Disassembly','Repair','DeepRepair','Assembly','Balancing']],
      ['DE-FRA','Francfort','Allemagne',7,['TestRun','Calibration','NDT','Assembly']],
      ['ES-MAD','Madrid','Espagne',6,['Cleaning','Painting','Documentation','Inspection','Assembly']],
      ['ES-BCN','Barcelone','Espagne',7,['Disassembly','Repair','Balancing','Calibration','Assembly']],
      ['UK-LON','Londres','Royaume-Uni',7,['TestRun','NDT','Calibration','Assembly','Inspection']],
      ['UK-MAN','Manchester','Royaume-Uni',7,['Repair','DeepRepair','Balancing','Assembly','TestRun']],
      ['IT-MIL','Milan','Italie',8,['Disassembly','Repair','DeepRepair','Cleaning','Assembly']],
      ['IT-TUR','Turin','Italie',6,['Inspection','Assembly','Balancing','Documentation','Painting']]
    ];
    S.shops = shops.map(([id,name,siteCountry,slotsPerDay,allowedOpTypes])=>({id,name,siteCountry,slotsPerDay,allowedOpTypes}));
  }

  function seedRequestsAndOps(){
    let reqId = 1, opId = 1;
    const rnd = (n)=>Math.floor(Math.random()*n);
    const pick = (arr)=>arr[rnd(arr.length)];

    // Create 10 requests
    for(let i=0;i<10;i++){
      const id = `REQ-${String(reqId++).padStart(3,'0')}`;
      const client = S.mdLists.clients[i % S.mdLists.clients.length];
      const engineModel = S.mdLists.engineModels[i % S.mdLists.engineModels.length];
      const requestType = pick(S.mdLists.requestTypes);
      const urgency = Math.random()<0.25 ? 'AOG' : 'Normal';
      const status = pick(S.mdLists.statuses);
      const siteCountry = S.mdLists.siteCountries[i % S.mdLists.siteCountries.length];
      const createdAt = shiftISO(todayISO, -rnd(7));
      const dueDate = shiftISO(todayISO, rnd(40)+7);

      const req = {id,client,engineModel,requestType,urgency,status,siteCountry,createdAt,dueDate,eta:''};
      S.requests.push(req);

      // 4 required operations from mapping
      const ops = S.mappings.requestTypeToOps[requestType];
      ops.forEach((opType,seq)=>{
        const shop = pick(shopsSupporting(opType, siteCountry));
        const plannedDate = shiftISO(todayISO, rnd(50));
        const durationSlots = S.mappings.opDurations[opType] || 1;
        const st = pick(S.mdLists.statuses);
        S.operations.push({id:`OP-${String(opId++).padStart(3,'0')}`, requestId:id, opType, shopId:shop.id, plannedDate, durationSlots, status:st, isRequired:true});
      });
    }

    // Add ~10 optional ops across requests to reach ~50
    const extraTypes = ['NDT','Calibration','Balancing','Documentation','Cleaning'];
    while(S.operations.length < 50){
      const req = pick(S.requests);
      const opType = pick(extraTypes);
      const shop = pick(shopsSupporting(opType, req.siteCountry));
      const plannedDate = shiftISO(todayISO, Math.floor(Math.random()*56));
      const durationSlots = S.mappings.opDurations[opType] || 1;
      const status = pick(S.mdLists.statuses);
      S.operations.push({id:`OP-${String(opId++).padStart(3,'0')}`, requestId:req.id, opType, shopId:shop.id, plannedDate, durationSlots, status, isRequired:false});
    }

    // Compute ETA for each request (max plannedDate of its ops)
    S.requests.forEach(r=>{ r.eta = computeETA(r.id); });
  }

  function shopsSupporting(opType, preferredCountry){
    const arr = S.shops.filter(s=>s.allowedOpTypes.includes(opType));
    const preferred = arr.filter(s=>s.siteCountry===preferredCountry);
    return preferred.length?preferred:arr;
  }

  // ---------- PERSIST ----------
  function persist(){ localStorage.setItem(KEY, JSON.stringify(S)); }

  // ---------- RENDER: NAV & FILTERS ----------
  function renderTabs(){
    document.querySelectorAll('nav.tabs button').forEach(btn=>{
      btn.onclick = ()=>{
        document.querySelectorAll('nav.tabs button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab; S.ui.tab = tab; persist();
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        document.getElementById('tab-'+tab).classList.add('active');
      };
    });
  }

  function renderFilters(){
    const f = S.ui.filters;
    const wrap = document.getElementById('filters');
    wrap.innerHTML = '';

    const makeSel = (label, key, options)=>{
      const sel = document.createElement('select');
      sel.title = label; sel.ariaLabel = label; sel.dataset.key = key;
      sel.innerHTML = `<option value="">${label}</option>` + options.map(o=>`<option ${f[key]===o?'selected':''}>${o}</option>`).join('');
      sel.onchange = ()=>{ S.ui.filters[key] = sel.value; renderKPIs(); renderHeatmap(); renderRequests(); renderOps(); persist(); };
      wrap.appendChild(sel);
    };

    makeSel('Pays', 'siteCountry', S.mdLists.siteCountries);
    const shopSel = document.createElement('select');
    shopSel.innerHTML = `<option value="">Shop</option>` + S.shops.map(s=>`<option value="${s.id}" ${f.shopId===s.id?'selected':''}>${s.name} (${s.siteCountry})</option>`).join('');
    shopSel.onchange = ()=>{ S.ui.filters.shopId = shopSel.value; renderKPIs(); renderHeatmap(); renderOps(); persist(); };
    wrap.appendChild(shopSel);

    makeSel('Type de demande','requestType',S.mdLists.requestTypes);
    makeSel('Urgence','urgency',S.mdLists.urgencies);
    makeSel('Statut','status',S.mdLists.statuses);
    makeSel('Type d\'op√©ration','opType',S.mdLists.opTypes);
  }

  function bindHeader(){
    document.getElementById('gotoToday').onclick = ()=> scrollHeatmapToToday();

    document.getElementById('exportBtn').onclick = exportJSON;
    document.getElementById('doExport').onclick = exportJSON;

    const importInputs = [document.getElementById('importInput'), document.getElementById('doImport')];
    importInputs.forEach(inp=> inp.addEventListener('change', handleImport));

    const resetBtns = [document.getElementById('resetBtn'), document.getElementById('doReset')];
    resetBtns.forEach(b=> b.onclick = resetData);

    document.getElementById('showJSON').onclick = ()=>{
      document.getElementById('jsonOut').textContent = JSON.stringify(S,null,2);
    };

    document.getElementById('searchBtn').onclick = searchById;
    document.getElementById('searchInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') searchById(); });
  }

  // ---------- RENDER: KPI ----------
  function renderKPIs(){
    const ops = filteredOpsForKPIs();

    // Utilisation globale = sum(used slots) / sum(total slots)
    let used = 0, total = 0;
    const days = S.ui.days;
    const shops = filteredShops();
    for(const s of shops){
      for(const d of days){
        const arr = ops.filter(o=>o.shopId===s.id && o.plannedDate===d);
        const sum = arr.reduce((a,b)=>a+(b.durationSlots||1),0);
        used += sum; total += s.slotsPerDay;
      }
    }
    const util = total? (100*used/total): 0;
    setText('kpiUtil', util? util.toFixed(0)+'%':'‚Äì');
    setText('kpiUtilTrend','');

    // % urgences livr√©es √† l'heure
    const aogDone = S.requests.filter(r=> r.urgency==='AOG' && r.status==='Termin√©');
    const aogOnTime = aogDone.filter(r=> (r.eta||todayISO) <= (r.dueDate||todayISO));
    setText('kpiAOG', aogDone.length? Math.round(100*aogOnTime.length/aogDone.length)+'%':'‚Äì');

    // Backlog / Retards
    const lateOps = S.operations.filter(o=>{
      const req = S.requests.find(r=>r.id===o.requestId);
      if(!req || !req.dueDate || !o.plannedDate) return false;
      return o.plannedDate>req.dueDate && (o.status!=='Termin√©');
    });
    const backlog = S.operations.filter(o=>!o.plannedDate).length;
    setText('kpiBacklog', `${backlog} / ${lateOps.length}`);

    // ETA moyen demandes actives
    const active = S.requests.filter(r=>r.status!=='Termin√©');
    const meanDays = active.length? Math.round(active.map(r=> daysBetween(todayISO, r.eta||todayISO)).reduce((a,b)=>a+b,0)/active.length) : null;
    setText('kpiETA', meanDays==null? '‚Äì' : (meanDays+' j'));
  }

  // ---------- RENDER: HEATMAP ----------
  function renderHeatmap(){
    const table = document.getElementById('heatmap');
    const days = S.ui.days;
    const shops = filteredShops();
    const ops = filteredOps();

    let thead = '<thead><tr><th>Shop / Jour</th>' + days.map(d=>`<th>${d.slice(5)}</th>`).join('') + '</tr></thead>';
    let rows = '';

    for(const s of shops){
      let tds = '';
      for(const d of days){
        const arr = ops.filter(o=>o.shopId===s.id && o.plannedDate===d);
        const slotsUsed = arr.reduce((a,b)=>a+(b.durationSlots||1),0);
        const pct = s.slotsPerDay? Math.round(100*slotsUsed/s.slotsPerDay) : 0;
        const cls = pct===0? 'occ-0' : pct<=85? 'occ-ok' : pct<=100? 'occ-warn' : 'occ-bad';
        const title = `${s.name} ‚Äî ${d}\nCharge: ${slotsUsed}/${s.slotsPerDay} slots (${pct}%)\nOp√©s: ${arr.length}`;
        tds += `<td class="cell ${cls}" title="${title}"><a href="#" data-shop="${s.id}" data-date="${d}">${pct||''}</a></td>`;
      }
      rows += `<tr><th>${s.name} <span class="badge">${s.siteCountry}</span></th>${tds}</tr>`;
    }

    table.innerHTML = thead + '<tbody>'+rows+'</tbody>';

    // Click handler to open operations tab with filters
    table.querySelectorAll('a[data-shop]').forEach(a=>{
      a.onclick = (e)=>{
        e.preventDefault();
        const shopId = a.dataset.shop; const date = a.dataset.date;
        S.ui.opFilter = {shopId,date};
        persist();
        // switch tab
        document.querySelector('nav.tabs button[data-tab="operations"]').click();
        renderOps();
      };
    });

    scrollHeatmapToToday();
  }

  function scrollHeatmapToToday(){
    const wrap = document.getElementById('heatWrap');
    const days = S.ui.days; const idx = days.indexOf(todayISO);
    if(idx>=0){
      const ths = document.querySelectorAll('#heatmap thead th');
      const target = ths[idx+1];
      if(target){ wrap.scrollLeft = Math.max(0, target.offsetLeft - 120); }
    }
  }

  // ---------- RENDER: REQUESTS ----------
  function renderRequests(){
    // recompute ETA on the fly
    S.requests.forEach(r=> r.eta = computeETA(r.id));

    const tb = document.querySelector('#tblRequests tbody');
    const list = filteredRequests();
    tb.innerHTML = list.map(r=>{
      const badge = (t)=>`<span class="badge">${t}</span>`;
      return `<tr>
        <td><a href="#" data-open-request="${r.id}">${r.id}</a></td>
        <td>${r.client}</td>
        <td>${r.engineModel}</td>
        <td>${badge(r.requestType)}</td>
        <td>${badge(r.urgency)}</td>
        <td>${badge(r.status)}</td>
        <td>${r.siteCountry}</td>
        <td>${r.dueDate||''}</td>
        <td>${r.eta||''}</td>
      </tr>`;
    }).join('');

    document.querySelectorAll('[data-open-request]').forEach(a=>{
      a.onclick = (e)=>{ e.preventDefault(); openRequestDrawer(a.dataset.openRequest); };
    });
  }

  // ---------- RENDER: OPERATIONS ----------
  function renderOps(){
    const tb = document.querySelector('#tblOps tbody');
    const {shopId,date} = S.ui.opFilter||{};
    const desc = [];
    if(shopId){ const s = S.shops.find(x=>x.id===shopId); if(s) desc.push(s.name); }
    if(date){ desc.push(date); }
    document.getElementById('opFilterDesc').textContent = desc.length? desc.join(' ‚Ä¢ ') : '(aucun)';

    const list = filteredOps();
    const filtered = list.filter(o=> (!shopId||o.shopId===shopId) && (!date||o.plannedDate===date));

    tb.innerHTML = filtered.map(o=>{
      const shop = S.shops.find(s=>s.id===o.shopId); const r = S.requests.find(x=>x.id===o.requestId);
      return `<tr>
        <td><a href="#" data-open-op="${o.id}">${o.id}</a></td>
        <td><a href="#" data-open-request="${r.id}">${r.id}</a></td>
        <td>${o.opType}</td>
        <td>${shop?shop.name:o.shopId}</td>
        <td>${o.plannedDate||''}</td>
        <td>${o.durationSlots||1}</td>
        <td>${o.status}</td>
      </tr>`;
    }).join('');

    document.querySelectorAll('[data-open-op]').forEach(a=> a.onclick = (e)=>{ e.preventDefault(); openOperationDrawer(a.dataset.openOp); });
    document.querySelectorAll('[data-open-request]').forEach(a=> a.onclick = (e)=>{ e.preventDefault(); openRequestDrawer(a.dataset.openRequest); });
  }

  // ---------- RENDER: MASTER ----------
  function renderMaster(){
    const tb = document.querySelector('#tblShops tbody');
    tb.innerHTML = S.shops.map(s=> `<tr><td>${s.id}</td><td>${s.name}</td><td>${s.siteCountry}</td><td>${s.slotsPerDay}</td><td>${s.allowedOpTypes.join(', ')}</td></tr>`).join('');

    const mapReq = document.getElementById('mapReq');
    mapReq.innerHTML = Object.entries(S.mappings.requestTypeToOps).map(([rt,ops])=> `<div class="help"><strong>${rt}</strong>: ${ops.join(' ‚Üí ')}</div>`).join('');

    const mapDur = document.getElementById('mapDur');
    mapDur.innerHTML = Object.entries(S.mappings.opDurations).map(([ot,d])=> `<span class="pill">${ot}: ${d}</span>`).join(' ');
  }

  // ---------- DRAWERS (EDIT FORMS) ----------
  function openRequestDrawer(id){
    const r = S.requests.find(x=>x.id===id); if(!r) return;
    const ops = S.operations.filter(o=>o.requestId===r.id);

    const panel = document.getElementById('drawerPanel');
    panel.innerHTML = `
      <h2>Demande ${r.id}</h2>
      <div class="form">
        <div class="row">
          <label>Client<select id="r_client">${opts(S.mdLists.clients,r.client)}</select></label>
          <label>Mod√®le<select id="r_engine">${opts(S.mdLists.engineModels,r.engineModel)}</select></label>
        </div>
        <div class="row">
          <label>Type de demande<select id="r_type">${opts(S.mdLists.requestTypes,r.requestType)}</select></label>
          <label>Urgence<select id="r_urg">${opts(S.mdLists.urgencies,r.urgency)}</select></label>
        </div>
        <div class="row">
          <label>Statut<select id="r_status">${opts(S.mdLists.statuses,r.status)}</select></label>
          <label>Pays<select id="r_country">${opts(S.mdLists.siteCountries,r.siteCountry)}</select></label>
        </div>
        <div class="row">
          <label>Due date<input type="date" id="r_due" value="${r.dueDate||''}"></label>
          <label>ETA (calcul√©e)<input type="date" id="r_eta" value="${r.eta||''}" disabled></label>
        </div>
        <div>
          <strong>Op√©rations (${ops.length})</strong>
          <ul class="help">${ops.map(o=>`<li><a href="#" data-open-op="${o.id}">${o.id}</a> ‚Äî ${o.opType} ‚Ä¢ ${o.plannedDate||'‚Äî'} ‚Ä¢ ${shopName(o.shopId)}</li>`).join('')}</ul>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="regenOps">R√©g√©n√©rer les 4 op√©rations</button>
        <button class="btn primary" id="saveReq">Enregistrer</button>
        <button class="btn ghost" id="closeDrawer">Fermer</button>
      </div>`;

    openDrawer();

    panel.querySelectorAll('[data-open-op]').forEach(a=> a.onclick = (e)=>{ e.preventDefault(); openOperationDrawer(a.dataset.openOp); });

    document.getElementById('closeDrawer').onclick = closeDrawer;
    document.getElementById('saveReq').onclick = ()=>{
      r.client = val('r_client'); r.engineModel = val('r_engine'); r.requestType = val('r_type'); r.urgency = val('r_urg');
      r.status = val('r_status'); r.siteCountry = val('r_country'); r.dueDate = val('r_due'); r.eta = computeETA(r.id);
      persist(); renderAll(); closeDrawer();
    };
    document.getElementById('regenOps').onclick = ()=>{
      if(!confirm('Confirmer la r√©g√©n√©ration des 4 op√©rations requises pour '+r.requestType+' ? Les op√©rations requises existantes seront remplac√©es.')) return;
      // Remove required ops for this request
      S.operations = S.operations.filter(o=> !(o.requestId===r.id && o.isRequired));
      // Recreate 4
      const ops = S.mappings.requestTypeToOps[r.requestType]||[];
      ops.forEach(opType=>{
        const shop = pickOne(shopsSupporting(opType, r.siteCountry));
        const plannedDate = shiftISO(todayISO, Math.floor(Math.random()*56));
        const durationSlots = S.mappings.opDurations[opType]||1;
        const status = pickOne(S.mdLists.statuses);
        const newId = nextOpId();
        S.operations.push({id:newId, requestId:r.id, opType, shopId:shop.id, plannedDate, durationSlots, status, isRequired:true});
      });
      r.eta = computeETA(r.id);
      persist(); renderAll(); openRequestDrawer(r.id); // refresh panel
    };
  }

  function openOperationDrawer(id){
    const o = S.operations.find(x=>x.id===id); if(!o) return;
    const r = S.requests.find(x=>x.id===o.requestId);
    const allowedShops = S.shops.filter(s=> s.allowedOpTypes.includes(o.opType));

    const panel = document.getElementById('drawerPanel');
    panel.innerHTML = `
      <h2>Op√©ration ${o.id}</h2>
      <div class="form">
        <div class="row">
          <label>Request<input value="${r.id}" disabled></label>
          <label>Type d'op√©ration<input value="${o.opType}" disabled></label>
        </div>
        <div class="row">
          <label>Shop<select id="o_shop">${allowedShops.map(s=>`<option value="${s.id}" ${s.id===o.shopId?'selected':''}>${s.name} (${s.siteCountry})</option>`).join('')}</select></label>
          <label>Date planifi√©e<input type="date" id="o_date" value="${o.plannedDate||''}"></label>
        </div>
        <div class="row">
          <label>Dur√©e (slots)<input type="number" min="1" max="24" id="o_slots" value="${o.durationSlots||1}"></label>
          <label>Statut<select id="o_status">${opts(S.mdLists.statuses,o.status)}</select></label>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" id="saveOp">Enregistrer</button>
        <button class="btn ghost" id="closeDrawer">Fermer</button>
      </div>`;

    openDrawer();
    document.getElementById('closeDrawer').onclick = closeDrawer;
    document.getElementById('saveOp').onclick = ()=>{
      const newShop = val('o_shop');
      const newDate = val('o_date');
      const newSlots = Math.max(1, parseInt(val('o_slots')||'1',10));
      const newStatus = val('o_status');

      // Validate capacity warning
      const s = S.shops.find(x=>x.id===newShop);
      const sameDayOps = S.operations.filter(x=> x.id!==o.id && x.shopId===newShop && x.plannedDate===newDate);
      const usedSlots = sameDayOps.reduce((a,b)=>a+(b.durationSlots||1),0);
      if(usedSlots + newSlots > s.slotsPerDay){
        if(!confirm(`Attention: surcharge ${usedSlots+newSlots}/${s.slotsPerDay} slots. Continuer ?`)) return;
      }

      o.shopId = newShop; o.plannedDate = newDate; o.durationSlots = newSlots; o.status = newStatus;
      // update ETA of parent
      const req = S.requests.find(x=>x.id===o.requestId); if(req){ req.eta = computeETA(req.id); }

      persist(); renderAll(); closeDrawer();
    };
  }

  function openDrawer(){ document.getElementById('drawer').classList.add('open'); }
  function closeDrawer(){ document.getElementById('drawer').classList.remove('open'); }

  // ---------- SEARCH ----------
  function searchById(){
    const q = document.getElementById('searchInput').value.trim().toUpperCase();
    if(!q) return;
    if(q.startsWith('REQ-')){
      const r = S.requests.find(x=>x.id===q); if(r){ openRequestDrawer(r.id); return; }
    }
    if(q.startsWith('OP-')){
      const o = S.operations.find(x=>x.id===q); if(o){ openOperationDrawer(o.id); return; }
    }
    alert('Aucun √©l√©ment avec cet ID.');
  }

  // ---------- IMPORT / EXPORT / RESET ----------
  function exportJSON(){
    const blob = new Blob([JSON.stringify(S,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'maestro-data.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  function handleImport(e){
    const file = e.target.files[0]; if(!file) return;
    const fr = new FileReader();
    fr.onload = ()=>{
      try{
        const data = JSON.parse(fr.result);
        // minimal validation
        if(!data || !Array.isArray(data.requests) || !Array.isArray(data.operations) || !Array.isArray(data.shops)) throw new Error('JSON invalide');
        Object.assign(S, data);
        // refresh rolling horizon days from today
        S.ui.days = generateDays(56);
        persist(); renderAll(); alert('Import r√©ussi.');
      }catch(err){ alert('√âchec import: '+err.message); }
    };
    fr.readAsText(file);
    e.target.value = '';
  }

  function resetData(){
    if(!confirm('R√©initialiser les donn√©es (seed) ?')) return;
    localStorage.removeItem(KEY);
    location.reload();
  }

  // ---------- HELPERS ----------
  function setText(id, v){ const el = document.getElementById(id); if(el) el.textContent = v; }
  function val(id){ return (document.getElementById(id)||{}).value; }
  function opts(arr, selected){ return arr.map(x=>`<option ${x===selected?'selected':''}>${x}</option>`).join(''); }
  function shopName(id){ const s = S.shops.find(x=>x.id===id); return s? s.name: id; }
  function pickOne(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function shiftISO(iso, deltaDays){ const d = new Date(iso); d.setDate(d.getDate()+deltaDays); return d.toISOString().slice(0,10); }
  function daysBetween(a,b){ return Math.round((new Date(b)-new Date(a))/86400000); }

  function generateDays(n){
    const days=[]; const d=new Date(); d.setHours(12,0,0,0); // avoid tz edge
    for(let i=0;i<n;i++){ const dd=new Date(d); dd.setDate(d.getDate()+i); days.push(dd.toISOString().slice(0,10)); }
    return days;
  }

  function filteredShops(){
    const f = S.ui.filters; let arr = S.shops.slice();
    if(f.siteCountry) arr = arr.filter(s=>s.siteCountry===f.siteCountry);
    if(f.shopId) arr = arr.filter(s=>s.id===f.shopId);
    return arr;
  }

  function filteredRequests(){
    const f = S.ui.filters; let arr = S.requests.slice();
    if(f.siteCountry) arr = arr.filter(r=>r.siteCountry===f.siteCountry);
    if(f.requestType) arr = arr.filter(r=>r.requestType===f.requestType);
    if(f.urgency) arr = arr.filter(r=>r.urgency===f.urgency);
    if(f.status) arr = arr.filter(r=>r.status===f.status);
    return arr;
  }

  function filteredOps(){
    const f = S.ui.filters; let arr = S.operations.slice();
    if(f.siteCountry) arr = arr.filter(o=>{ const r = S.requests.find(x=>x.id===o.requestId); return r && r.siteCountry===f.siteCountry; });
    if(f.shopId) arr = arr.filter(o=>o.shopId===f.shopId);
    if(f.requestType) arr = arr.filter(o=>{ const r = S.requests.find(x=>x.id===o.requestId); return r && r.requestType===f.requestType; });
    if(f.urgency) arr = arr.filter(o=>{ const r = S.requests.find(x=>x.id===o.requestId); return r && r.urgency===f.urgency; });
    if(f.status) arr = arr.filter(o=>o.status===f.status);
    if(f.opType) arr = arr.filter(o=>o.opType===f.opType);
    return arr;
  }

  function filteredOpsForKPIs(){
    // KPIs ignore opType filter to represent global capacity picture, but honor site & shop & status
    const f = S.ui.filters; let arr = S.operations.slice();
    if(f.siteCountry) arr = arr.filter(o=>{ const r = S.requests.find(x=>x.id===o.requestId); return r && r.siteCountry===f.siteCountry; });
    if(f.shopId) arr = arr.filter(o=>o.shopId===f.shopId);
    if(f.status) arr = arr.filter(o=>o.status===f.status);
    return arr;
  }

  function computeETA(requestId){
    const ops = S.operations.filter(o=>o.requestId===requestId);
    if(!ops.length) return '';
    // ETA approxim√©e = max(plannedDate) des op√©rations
    const maxDate = ops.filter(o=>o.plannedDate).reduce((max,o)=> max>o.plannedDate?max:o.plannedDate, ops[0].plannedDate);
    return maxDate || '';
  }

  function nextOpId(){
    const nums = S.operations.map(o=>parseInt((o.id||'').split('-')[1]||'0',10)).filter(n=>!isNaN(n));
    const next = (nums.length? Math.max(...nums):0) + 1;
    return `OP-${String(next).padStart(3,'0')}`;
  }
})();
</script>
</body>
</html>
