<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MAESTRO ‚Äî Prototype Fiori (TE-light ‚Ä¢ Rebuild)</title>
  <style>
    :root{
      --bg:#f6f7f9;--card:#fff;--text:#1b1f24;--muted:#6b7280;--brand:#0a6ed1;--border:#e5e7eb;
      --ok:#2ecc71;--warn:#f1c40f;--bad:#e74c3c;--chip:#eef2f7;
      --green-bg:#e8f5e9;--yellow-bg:#fffbe6
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    .app{display:flex;flex-direction:column;min-height:100vh;width:100vw;max-width:100vw}
    .topbar{position:sticky;top:0;z-index:10;background:var(--card);box-shadow:0 1px 0 var(--border);padding:12px 20px;display:flex;gap:16px;align-items:center}
    .brand{font-weight:700}
    .pill{padding:4px 8px;border-radius:999px;background:var(--chip);color:var(--muted);font-size:12px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{border:none;background:transparent;padding:10px 12px;border-radius:10px;cursor:pointer;color:var(--muted);font-weight:600}
    .tab.active{color:#fff;background:var(--brand)}
    .content{flex:1;display:flex;flex-direction:column;padding:14px;gap:14px;width:100%}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.02)}
    .card h3{margin:0 0 8px 0;font-size:16px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;width:100%}
    @media(max-width:1200px){.row{grid-template-columns:repeat(6,1fr)}}
    @media(max-width:800px){.row{grid-template-columns:repeat(2,1fr)}}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    select,input[type="number"],input[type="text"],input[type="date"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#fff}
    .btn{appearance:none;border:none;background:var(--brand);color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn.secondary{background:#e9eef6;color:#0a2540}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .table{width:100%;border-collapse:separate;border-spacing:0;overflow:auto}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
    .table th{font-size:12px;color:var(--muted);font-weight:700}
    .badge{padding:3px 8px;border-radius:999px;background:var(--chip);font-size:12px}

    .grid{display:grid;gap:8px}
    .eta-grid{grid-template-columns:220px 1fr 1fr 1.6fr}
    .eta-head{font-size:12px;color:var(--muted);font-weight:700}
    .eta-row{display:contents}
    .eta-cell{padding:6px 8px;border-bottom:1px solid var(--border)}
    .best-resp{background:var(--green-bg);border-radius:10px}
    .best-fast{background:var(--yellow-bg);border-radius:10px}
    .red{color:var(--bad);font-weight:700}

    .heatmap{display:grid;grid-template-columns:220px repeat(12,1fr);gap:4px;align-items:stretch}
    .heat-head{font-size:12px;color:var(--muted)}
    .heat-label{padding:6px 8px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .heat-cell{height:34px;border-radius:8px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px}

    .footer{padding:10px;color:var(--muted);text-align:center}
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="brand">üõ†Ô∏è MAESTRO ‚Äî Maintenance ‚Ä¢ <span class="pill">Prototype Fiori ‚Ä¢ TE-light (Rebuild)</span></div>
    <div class="tabs" role="tablist" aria-label="Navigation des onglets">
      <button class="tab active" data-tab="t1">1) üì• Demande & Reco</button>
      <button class="tab" data-tab="t2">2) üß© Master Data</button>
      <button class="tab" data-tab="t3">3) üìÑ Demandes ‚Ä¢ Liste</button>
    </div>
  </div>

  <div class="content">
    <!-- TAB 1 -->
    <section id="t1" class="card">
      <h3>üì• Saisie & recommandations (‚ö° FastETA ‚Ä¢ üçÄ ResponsibleETA)</h3>
      <div class="row" style="align-items:end">
        <div class="field"><label>Client</label><select id="r-client"></select></div>
        <div class="field"><label>Moteur</label><select id="r-engine"></select></div>
        <div class="field"><label>Type de demande</label><select id="r-type"></select></div>
        <div class="field"><label>Priorit√©</label>
          <select id="r-priority"><option>Urgent</option><option selected>Standard</option></select>
        </div>
        <div class="field"><label>Date de mise √† disposition</label><input id="r-available" type="date" /></div>
        <div class="field"><button class="btn" id="btn-evaluate">√âvaluer</button></div>
        <div class="field"><button class="btn secondary" id="btn-add">Ajouter au planning</button><span class="badge">Maj charge & heatmap</span></div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="grid eta-grid">
          <div class="eta-head">Centre</div>
          <div class="eta-head">‚ö° FastETA (j)</div>
          <div class="eta-head">üçÄ ResponsibleETA (j)</div>
          <div class="eta-head">D√©tails</div>
          <div id="eta-rows" style="display:contents"></div>
        </div>
        <div class="badge" id="eta-hint">Tri par üçÄ ResponsibleETA. Fixe: ship(client√ócentre) & dur(type√óengine).</div>
      </div>

      <!-- Heatmap int√©gr√©e, ind√©pendante -->
      <div class="card" style="margin-top:14px">
        <h3>üè≠ Heatmap TE (type√ómoteur) ‚Äî ind√©pendante</h3>
        <div class="toolbar"><label class="field" style="min-width:240px"><span>Centre</span>
          <select id="c-centre-t1"></select></label>
        </div>
        <div class="card">
          <div class="heatmap" id="heatmap-t1"></div>
          <div class="badge">En-t√™tes = 1er jour de semaine (DD/MM/YYYY). Chaque cellule = max(chargeTE/capTE) hebdo.</div>
        </div>
      </div>
    </section>

    <!-- TAB 2 -->
    <section id="t2" class="card" hidden>
      <h3>üß© Master Data & Randomization</h3>
      <div class="row">
        <div class="field"><label>Seed</label><input type="number" id="m-seed" value="42"/></div>
        <div class="field"><label>Horizon (sem.)</label><input type="number" id="m-weeks" value="12" min="4" max="26"/></div>
        <div class="field"><label>Clients (N)</label><input type="number" id="m-clients" value="30" min="1"/></div>
        <div class="field"><label>Demandes existantes (N)</label><input type="number" id="m-reqs" value="250" min="0"/></div>
        <div class="field"><label>% Urgent</label><input type="number" id="m-pUrgent" value="25" min="0" max="100"/></div>
        <div class="field"><label>Slots/jour min</label><input type="number" id="m-capMin" value="4"/></div>
        <div class="field"><label>Slots/jour max</label><input type="number" id="m-capMax" value="10"/></div>
        <div class="field"><label>Tendance (%) min</label><input type="number" id="m-trendMin" value="-10"/></div>
        <div class="field"><label>Tendance (%) max</label><input type="number" id="m-trendMax" value="10"/></div>
      </div>
      <h3>Dur√©es par type (triangulaire, jours) ‚Üí g√®le dur(type√óengine)</h3>
      <div class="row">
        <div class="field"><label>TestOnly</label><input type="text" id="m-dur-test" value="2,3,4"/></div>
        <div class="field"><label>QuickInspection</label><input type="text" id="m-dur-qi" value="3,4,6"/></div>
        <div class="field"><label>RepairOnly</label><input type="text" id="m-dur-rep" value="12,18,28"/></div>
        <div class="field"><label>Overhaul</label><input type="text" id="m-dur-ovh" value="35,45,65"/></div>
      </div>
      <h3>Acheminement (jours, poids 0..4) ‚Üí ship(client√ócentre) fixe</h3>
      <div class="row">
        <div class="field"><label>Poids 0j</label><input type="number" id="m-w0" value="25"/></div>
        <div class="field"><label>Poids 1j</label><input type="number" id="m-w1" value="35"/></div>
        <div class="field"><label>Poids 2j</label><input type="number" id="m-w2" value="20"/></div>
        <div class="field"><label>Poids 3j</label><input type="number" id="m-w3" value="15"/></div>
        <div class="field"><label>Poids 4j</label><input type="number" id="m-w4" value="5"/></div>
      </div>
      <h3>R√®gles</h3>
      <div class="row">
        <div class="field"><label>Facteur p√©nalit√© saturation</label><input type="number" id="m-penaltyFactor" value="1.0" step="0.1"/></div>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn" id="btn-regenerate">Reg√©n√©rer</button>
        <button class="btn ghost" id="btn-export">Export JSON</button>
        <input type="file" id="import-file" accept="application/json" hidden>
        <button class="btn ghost" id="btn-import">Import JSON</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>R√©sum√© des compatibilit√©s</h3>
        <table class="table" id="compat-table"></table>
      </div>
    </section>

    <!-- TAB 3 -->
    <section id="t3" class="card" hidden>
      <h3>üìÑ Toutes les demandes</h3>
      <div class="toolbar">
        <label>Centre <select id="f-centre"></select></label>
        <label>Moteur <select id="f-engine"></select></label>
        <label>Type <select id="f-type"></select></label>
        <label>Priorit√© <select id="f-prio"><option>All</option><option>Urgent</option><option selected>Standard</option></select></label>
        <label>De <input type="date" id="f-from"></label>
        <label>√Ä <input type="date" id="f-to"></label>
        <button class="btn ghost" id="btn-reset-f">R√©initialiser</button>
      </div>
      <div class="card"><table class="table" id="req-table"></table></div>
    </section>
  </div>

  <div class="footer">Prototype HTML standalone ‚Ä¢ Fiori-like ‚Ä¢ largeur totale ‚Ä¢ TE-light</div>
</div>

<script>
// ===== Helpers & safety =====
(function(){
  const css = `.toast{position:fixed;top:12px;right:12px;background:#ffeaea;color:#8b0000;border:1px solid #f5c2c7;padding:10px 12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.05);font:13px/1.4 system-ui}`;
  const style=document.createElement('style'); style.textContent=css; document.head.appendChild(style);
  window.__toast = (msg)=>{ const t=document.createElement('div'); t.className='toast'; t.textContent='Erreur: '+msg; document.body.appendChild(t); setTimeout(()=>t.remove(), 4000) }
  window.addEventListener('error', e=>{ try{ window.__toast(e.message) }catch(_){} })
})();

function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
let RNG = mulberry32(42);
function seedRng(s){RNG = mulberry32(Number(s)||42)}
function rand(){return RNG()}
function rInt(min,max){return Math.floor(rand()*(max-min+1))+min}
function choice(arr){return arr[Math.floor(rand()*arr.length)]}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(rand()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function clamp(v,min,max){return v<min?min:v>max?max:v}
function triangular(min,mode,max){const u=rand();const c=(mode-min)/(max-min);return u<c?min+Math.sqrt(u*(max-min)*(mode-min)):max-Math.sqrt((1-u)*(max-min)*(max-mode))}
function days(n){return n*24*60*60*1000}
function startOfToday(){const d=new Date();d.setHours(0,0,0,0);return d}
function getInputDate(id){
  const el=document.getElementById(id); if(!el) return State.baseDate;
  if(typeof el.valueAsDate!=="undefined" && el.valueAsDate) return el.valueAsDate;
  if(el.value){ const p=el.value.split('-'); if(p.length===3) return new Date(Number(p[0]), Number(p[1])-1, Number(p[2])) }
  return State.baseDate;
}
function keyTE(t,e){return t+'|'+e}
function pad2(n){return String(n).padStart(2,'0')} 
function fmtDate(d){return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`}

// ===== Master Data =====
const ENGINES=["LEAP-1A","LEAP-1B","CFM56-5B","CFM56-7B","SaM146"]
const TYPES=["Overhaul","RepairOnly","QuickInspection","TestOnly"]
const CITIES=["Paris","Lyon","Toulouse","Bordeaux","Nantes","Lille","Marseille","Nice","Strasbourg","Rennes","Grenoble","Montpellier","Clermont-F.","Rouen","Tours","Dijon","Nancy","Orl√©ans","Metz","Reims"]

const Params={
  seed:42,weeks:12,clients:30,existing:250,pUrgent:25,
  capMin:4,capMax:10,trendMin:-10,trendMax:10,
  durations:{TestOnly:[2,3,4],QuickInspection:[3,4,6],RepairOnly:[12,18,28],Overhaul:[35,45,65]},
  shipW:[25,35,20,15,5],
  penaltyFactor:1.0
}

let State={
  baseDate:startOfToday(), horizonDays:84,
  centres:[], customers:[], demands:[],
  compatSummary:[], shipDays:{}, opDurTE:{},
}

// ===== Generation =====
function buildCentres(){
  const centres=[]
  for(let i=0;i<20;i++){
    const name=CITIES[i]
    const engines=shuffle([...ENGINES]).slice(0,rInt(2,3))
    const types=shuffle([...TYPES]).slice(0,rInt(2,3))
    const capBase=rInt(Params.capMin,Params.capMax)
    const trend= (rInt(Params.trendMin,Params.trendMax))/100
    const capByDay=[]
    for(let d=0; d<State.horizonDays; d++){
      const date=new Date(State.baseDate.getTime()+days(d))
      const wd=date.getDay()
      let factor=1
      if(wd===0) factor=clamp(0.5+rand()*0.1,0.4,0.6)
      else if(wd===6) factor=clamp(0.6+rand()*0.2,0.6,0.8)
      else if(wd===5) factor=clamp(0.8+rand()*0.2,0.8,1.0)
      else factor=clamp(0.9+rand()*0.2,0.9,1.1)
      const drift=1 + trend * (d/(State.horizonDays-1))
      capByDay.push(Math.max(1, Math.round(capBase*factor*drift)))
    }
    // TE-light quotas uniformes
    const teList=[]; for(const t of types){ for(const e of engines){ teList.push(keyTE(t,e)) } }
    const quota= 1/Math.max(1, teList.length)
    const quotaTE={}; teList.forEach(k=>quotaTE[k]=quota)
    centres.push({
      id:i,name,engines:new Set(engines),types:new Set(types),
      capBase,trend,capByDay,quotaTE,
      loadByDay:new Array(State.horizonDays).fill(0),
      loadByDayByType:Object.fromEntries(TYPES.map(t=>[t,new Array(State.horizonDays).fill(0)])),
      loadByDayByTE:Object.fromEntries(teList.map(k=>[k,new Array(State.horizonDays).fill(0)]))
    })
  }
  State.centres=centres
}

function buildCustomers(){
  State.customers = Array.from({length:Params.clients},(_,i)=>`Client-${String(i+1).padStart(3,'0')}`)
}

function sampleShipDays(){
  const w=Params.shipW; const sum=w.reduce((a,b)=>a+b,0); let x=rand()*sum; let s=0
  for(let i=0;i<w.length;i++){ s+=w[i]; if(x<=s) return i }
  return 4
}

function buildShipMatrix(){
  const ship={}
  for(const cl of State.customers){
    ship[cl]={}
    for(const c of State.centres){ ship[cl][c.name]=sampleShipDays() }
  }
  State.shipDays=ship
}

function buildOpDurTE(){
  const table={}
  for(const t of TYPES){
    table[t]={}
    const [min,mode,max]=Params.durations[t]
    for(const e of ENGINES){ table[t][e]=Math.round(triangular(min,mode,max)) }
  }
  State.opDurTE=table
}

function placeDemandOnCalendar(d){
  const c=d.centre
  const startIdx=Math.max(0,Math.floor((d.startDate-State.baseDate)/days(1)))
  const te=keyTE(d.type,d.engine)
  for(let k=0;k<d.duration;k++){
    const idx=startIdx+k; if(idx<0||idx>=State.horizonDays) continue
    c.loadByDay[idx]+=1
    c.loadByDayByType[d.type][idx]+=1
    if(c.loadByDayByTE[te]) c.loadByDayByTE[te][idx]+=1
  }
}

function buildExistingDemands(){
  State.demands=[]
  for(let i=0;i<Params.existing;i++){
    const type=choice(TYPES)
    const centre=choice(State.centres.filter(c=>c.types.has(type)))
    if(!centre) continue
    const engine=choice([...centre.engines])
    const priority = rand()*100 < Params.pUrgent ? 'Urgent' : 'Standard'
    const duration=State.opDurTE[type][engine]
    const startOffset=rInt(0,State.horizonDays-1)
    const startDate=new Date(State.baseDate.getTime()+days(startOffset))
    const d={id:`E${i+1}`, client: choice(State.customers), centre, centreName:centre.name, engine, type, priority, duration, startDate}
    State.demands.push(d); placeDemandOnCalendar(d)
  }
}

function rebuildCompatSummary(){
  State.compatSummary=State.centres.map(c=>{
    const teCount=Object.keys(c.quotaTE).length
    return {centre:c.name,moteurs:[...c.engines].join(', '),types:[...c.types].join(', '),capBase:c.capBase,te:teCount}
  })
}

function regenerate(){
  seedRng(Params.seed)
  State.baseDate=startOfToday(); State.horizonDays=Params.weeks*7
  buildCentres(); buildCustomers(); buildShipMatrix(); buildOpDurTE(); buildExistingDemands(); rebuildCompatSummary();
  hydrateUI(); evaluateCurrent(); buildHeatmapFor('c-centre-t1','heatmap-t1'); buildReqTable()
}

// ===== ETA (TE-light) =====
function avgDurationByType(type){ const [min,mode,max]=Params.durations[type]; return Math.round((min+mode+max)/3) }
function capTE(centre, teKey, dayIdx){ const q=centre.quotaTE[teKey]||0; const cap=centre.capByDay[dayIdx]||1; return Math.max(1, Math.round(cap*q)) }
function occWeekTE(centre, teKey, weekStartIdx){
  let maxOcc=0
  for(let i=weekStartIdx;i<weekStartIdx+7 && i<State.horizonDays;i++){
    const cap=capTE(centre, teKey, i)
    const load=(centre.loadByDayByTE[teKey]?.[i]||0)
    const occ = load / cap
    if(occ>maxOcc) maxOcc=occ
  }
  return maxOcc
}
function computePenaltyDays(centre,type,engine,anchorIdx){
  const teKey=keyTE(type,engine)
  const week4Start=(anchorIdx||0)+3*7
  const occ=occWeekTE(centre, teKey, week4Start)
  const excess=Math.max(0, occ-1)
  return Math.round(Params.penaltyFactor * excess * avgDurationByType(type))
}
function waitDaysIfFull(centre, type, engine, priority, anchorIdx){
  if(priority==='Urgent') return 0
  const teKey=keyTE(type,engine)
  const occ=occWeekTE(centre, teKey, anchorIdx||0)
  if(occ<=1) return 0
  return Math.ceil((occ-1)*7)
}
function evaluateRequest(req){
  const {client,engine,type,priority,available}=req
  const eligible=State.centres.filter(c=>c.engines.has(engine)&&c.types.has(type))
  const rows=[]
  const anchorIdx=Math.max(0, Math.floor(((available||State.baseDate)-State.baseDate)/days(1)))
  for(const c of eligible){
    const ship= (State.shipDays[client]&&State.shipDays[client][c.name]!==undefined)? State.shipDays[client][c.name]:0
    const shipOut=ship, shipBack=ship
    const dur=State.opDurTE[type][engine]
    const baseETA=shipOut+dur+shipBack
    const wait=waitDaysIfFull(c,type,engine,priority,anchorIdx)
    const fast=baseETA+wait
    const penalty=computePenaltyDays(c,type,engine,anchorIdx)
    const responsible=fast+penalty
    rows.push({centre:c,fast,responsible,shipOut,shipBack,dur,wait,penalty,
      detailHTML:`Aller ${shipOut}j ‚Ä¢ Ops ${dur}j ‚Ä¢ Attente <span class='${wait>0?"red":""}'>${wait}</span>j ‚Ä¢ Retour ${shipBack}j ‚Ä¢ P√©nalit√© <span class='${penalty>0?"red":""}'>${penalty}</span>j`})
  }
  const bestFast = rows.length? rows.reduce((p,c)=>c.fast<p.fast?c:p, rows[0]) : null
  const bestResp = rows.length? rows.reduce((p,c)=>c.responsible<p.responsible?c:p, rows[0]) : null
  rows.sort((a,b)=>a.responsible-b.responsible)
  return {rows,bestFast,bestResp}
}

// ===== UI =====
function hydrateSelectors(){
  document.getElementById('r-client').innerHTML=State.customers.map(c=>`<option>${c}</option>`).join('')
  document.getElementById('r-engine').innerHTML=ENGINES.map(e=>`<option>${e}</option>`).join('')
  document.getElementById('r-type').innerHTML=TYPES.map(t=>`<option>${t}</option>`).join('')
  document.getElementById('r-available').valueAsDate=State.baseDate
  document.getElementById('f-centre').innerHTML=['All',...State.centres.map(c=>c.name)].map(c=>`<option>${c}</option>`).join('')
  document.getElementById('f-engine').innerHTML=['All',...ENGINES].map(e=>`<option>${e}</option>`).join('')
  document.getElementById('f-type').innerHTML=['All',...TYPES].map(t=>`<option>${t}</option>`).join('')
  document.getElementById('f-from').valueAsDate=State.baseDate
  const to=new Date(State.baseDate.getTime()+days(State.horizonDays-1)); document.getElementById('f-to').valueAsDate=to
  const c1=document.getElementById('c-centre-t1'); if(c1){ c1.innerHTML=State.centres.map(c=>`<option>${c.name}</option>`).join('') }
}

function hydrateCompatTable(){
  const tbl=document.getElementById('compat-table'); if(!tbl) return
  tbl.innerHTML=`<thead><tr><th>Centre</th><th>Moteurs</th><th>Types</th><th>Cap. base</th><th>TE combos</th></tr></thead>`+
    '<tbody>'+State.compatSummary.map(r=>`<tr><td>${r.centre}</td><td>${r.moteurs}</td><td>${r.types}</td><td>${r.capBase}</td><td>${r.te}</td></tr>`).join('')+'</tbody>'
}

function evaluateCurrent(){
  const req={
    client:document.getElementById('r-client').value,
    engine:document.getElementById('r-engine').value,
    type:document.getElementById('r-type').value,
    priority:document.getElementById('r-priority').value,
    available:getInputDate('r-available')
  }
  const {rows,bestFast,bestResp}=evaluateRequest(req)
  const body=document.getElementById('eta-rows'); body.innerHTML=''
  for(const r of rows){
    const isFast= bestFast && r.centre===bestFast.centre
    const isResp= bestResp && r.centre===bestResp.centre
    const redFlag=(r.wait>0||r.penalty>0)
    body.insertAdjacentHTML('beforeend',`
      <div class="eta-row">
        <div class="eta-cell ${isResp?"best-resp":(isFast?"best-fast":"")}"><strong>${r.centre.name}</strong></div>
        <div class="eta-cell ${(isFast?"best-fast":"")} ${redFlag?"red":""}">${r.fast}</div>
        <div class="eta-cell ${(isResp?"best-resp":"")} ${redFlag?"red":""}">${r.responsible}</div>
        <div class="eta-cell">${r.detailHTML}</div>
      </div>`)
  }
  const hint=document.getElementById('eta-hint')
  if(bestFast||bestResp){
    const bf=bestFast? `${bestFast.centre.name} (${bestFast.fast}j ‚ö°)`:'‚Äî'
    const br=bestResp? `${bestResp.centre.name} (${bestResp.responsible}j üçÄ)`:'‚Äî'
    hint.textContent=`Tri: üçÄ Responsible ‚Ä¢ Reco ‚ö°: ${bf} ‚Ä¢ Reco üçÄ: ${br}`
  } else {
    hint.textContent='Aucun centre compatible pour ce type√ómoteur.'
  }
}

function buildHeatmapFor(selectId, containerId){
  const grid=document.getElementById(containerId); if(!grid) return; grid.innerHTML=''
  grid.insertAdjacentHTML('beforeend', `<div></div>${Array.from({length:Params.weeks},(_,i)=>{const d=new Date(State.baseDate.getTime()+days(i*7));return `<div class='heat-head' style='text-align:center'>${fmtDate(d)}</div>`}).join('')}`)
  const sel=document.getElementById(selectId)
  const centreName= sel && sel.value ? sel.value : (State.centres[0]?.name)
  const c=State.centres.find(x=>x.name===centreName) || State.centres[0]
  const teKeys=c? Object.keys(c.quotaTE):[]
  if(!c || teKeys.length===0){ grid.insertAdjacentHTML('beforeend', `<div class='heat-label'>Aucune compatibilit√©</div>`); return }
  for(const k of teKeys){
    const [t,e]=k.split('|')
    grid.insertAdjacentHTML('beforeend', `<div class='heat-label'>${t} √ó ${e}</div>`)
    for(let w=0;w<Params.weeks;w++){
      let maxOcc=0
      for(let i=w*7;i<Math.min(State.horizonDays,(w+1)*7);i++){
        const cap=capTE(c,k,i)
        const load=c.loadByDayByTE[k]?.[i]||0
        const occ= load/cap
        if(occ>maxOcc) maxOcc=occ
      }
      const p=clamp(maxOcc,0,1.5)
      const color= p<=0.5?`linear-gradient(0deg,#e8f5e9,#d6efdc)`: p<=1?`linear-gradient(0deg,#fff9e6,#ffecb3)`:`linear-gradient(0deg,#ffebe6,rgba(231,76,60,.25))`
      const label=Math.round(p*100)+"%"
      const weekStart=new Date(State.baseDate.getTime()+days(w*7))
      grid.insertAdjacentHTML('beforeend', `<div class='heat-cell' title='${k} ‚Ä¢ Semaine du ${fmtDate(weekStart)} ‚Ä¢ Occ ${label}' style='background:${color}'>${label}</div>`)
    }
  }
}

function buildReqTable(){
  const tbl=document.getElementById('req-table')
  const centre=document.getElementById('f-centre').value
  const engine=document.getElementById('f-engine').value
  const type=document.getElementById('f-type').value
  const prio=document.getElementById('f-prio').value
  const from=document.getElementById('f-from').valueAsDate
  const to=document.getElementById('f-to').valueAsDate
  const rows=State.demands.filter(d=>{
    if(centre && centre!=='All' && d.centreName!==centre) return false
    if(engine && engine!=='All' && d.engine!==engine) return false
    if(type && type!=='All' && d.type!==type) return false
    if(prio && prio!=='All' && d.priority!==prio) return false
    if(from && d.startDate<from) return false
    if(to){ const dt=new Date(to.getTime()); dt.setHours(23,59,59,999); if(d.startDate>dt) return false }
    return true
  })
  rows.sort((a,b)=>a.startDate-b.startDate)
  const head=`<thead><tr><th>#</th><th>Client</th><th>Centre</th><th>Moteur</th><th>Type</th><th>Priorit√©</th><th>D√©but</th><th>Dur√©e (j)</th></tr></thead>`
  const body='<tbody>'+rows.map(r=>`<tr><td>${r.id}</td><td>${r.client}</td><td>${r.centreName}</td><td>${r.engine}</td><td>${r.type}</td><td><span class='badge'>${r.priority}</span></td><td>${r.startDate.toISOString().slice(0,10)}</td><td>${r.duration}</td></tr>`).join('')+'</tbody>'
  tbl.innerHTML=head+body
}

function addCurrentRequest(){
  const type=document.getElementById('r-type').value
  const engine=document.getElementById('r-engine').value
  let centreNameBest=null
  const rows=document.querySelectorAll('#eta-rows .eta-row')
  if(rows.length){ centreNameBest = rows[0].querySelector('.eta-cell strong')?.textContent || null }
  let centre=State.centres.find(c=>c.name===centreNameBest && c.types.has(type) && c.engines.has(engine))
  if(!centre){ centre = State.centres.find(c=>c.types.has(type)&&c.engines.has(engine)) }
  if(!centre){ alert('Aucun centre compatible.'); return }
  const client=document.getElementById('r-client').value
  const priority=document.getElementById('r-priority').value
  const startDate=getInputDate('r-available')
  const duration=State.opDurTE[type][engine]
  const id=`N${State.demands.length+1}`
  const d={id, client, centre, centreName:centre.name, engine, type, priority, duration, startDate}
  State.demands.push(d); placeDemandOnCalendar(d)
  buildHeatmapFor('c-centre-t1','heatmap-t1'); buildReqTable(); evaluateCurrent()
}

function hydrateUI(){
  hydrateSelectors(); hydrateCompatTable()
}

// ===== Events =====
for(const b of document.querySelectorAll('.tab')){
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'))
    b.classList.add('active')
    const id=b.dataset.tab
    document.querySelectorAll('section.card').forEach(s=>s.hidden = s.id!==id)
    if(id==='t3') buildReqTable()
  })
}

document.getElementById('btn-evaluate').addEventListener('click', ()=>{ try{ evaluateCurrent() }catch(e){ __toast(e.message) } })
for(const id of ['r-client','r-engine','r-type','r-priority','r-available']){
  document.getElementById(id).addEventListener('change', ()=>{ try{ evaluateCurrent() }catch(e){ __toast(e.message) } })
}

document.getElementById('btn-add').addEventListener('click', ()=>{ try{ addCurrentRequest() }catch(e){ __toast(e.message) } })

function parseTriple(txt){return txt.split(',').map(x=>Number(x.trim()))}

document.getElementById('btn-regenerate').addEventListener('click',()=>{
  Params.seed=Number(document.getElementById('m-seed').value)
  Params.weeks=Number(document.getElementById('m-weeks').value)
  Params.clients=Number(document.getElementById('m-clients').value)
  Params.existing=Number(document.getElementById('m-reqs').value)
  Params.pUrgent=Number(document.getElementById('m-pUrgent').value)
  Params.capMin=Number(document.getElementById('m-capMin').value)
  Params.capMax=Number(document.getElementById('m-capMax').value)
  Params.trendMin=Number(document.getElementById('m-trendMin').value)
  Params.trendMax=Number(document.getElementById('m-trendMax').value)
  Params.durations.TestOnly=parseTriple(document.getElementById('m-dur-test').value)
  Params.durations.QuickInspection=parseTriple(document.getElementById('m-dur-qi').value)
  Params.durations.RepairOnly=parseTriple(document.getElementById('m-dur-rep').value)
  Params.durations.Overhaul=parseTriple(document.getElementById('m-dur-ovh').value)
  Params.shipW=[0,1,2,3,4].map(i=>Number(document.getElementById('m-w'+i).value))
  Params.penaltyFactor=Number(document.getElementById('m-penaltyFactor').value)
  regenerate()
})

// Export/Import
function download(filename, text){ const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(text); a.download=filename; a.style.display='none'; document.body.appendChild(a); a.click(); a.remove() }

document.getElementById('btn-export').addEventListener('click',()=>{
  const out={Params, State:{
    baseDate:State.baseDate.toISOString().slice(0,10), horizonDays:State.horizonDays,
    centres: State.centres.map(c=>({name:c.name, engines:[...c.engines], types:[...c.types], capBase:c.capBase, trend:c.trend, capByDay:c.capByDay, quotaTE:c.quotaTE})),
    demands: State.demands.map(d=>({id:d.id, client:d.client, centre:d.centreName, engine:d.engine, type:d.type, priority:d.priority, duration:d.duration, startDate:d.startDate.toISOString().slice(0,10)})),
    shipDays: State.shipDays, opDurTE: State.opDurTE
  }}
  download('maestro_te_light.json', JSON.stringify(out,null,2))
})

document.getElementById('btn-import').addEventListener('click',()=>document.getElementById('import-file').click())

document.getElementById('import-file').addEventListener('change',evt=>{
  const file=evt.target.files[0]; if(!file) return
  const r=new FileReader(); r.onload=()=>{
    try{
      const data=JSON.parse(r.result)
      Object.assign(Params, data.Params||{})
      State.baseDate=new Date(data.State?.baseDate||startOfToday())
      State.horizonDays=data.State?.horizonDays||Params.weeks*7
      seedRng(Params.seed)
      buildCentres(); buildCustomers();
      if(Array.isArray(data.State?.centres)){
        data.State.centres.slice(0,20).forEach((c,i)=>{
          const tgt=State.centres[i]
          tgt.name=c.name; tgt.engines=new Set(c.engines||[]); tgt.types=new Set(c.types||[]);
          tgt.capBase=c.capBase||tgt.capBase; tgt.trend=c.trend||tgt.trend; tgt.capByDay=c.capByDay||tgt.capByDay; tgt.quotaTE=c.quotaTE||tgt.quotaTE
          tgt.loadByDay=new Array(State.horizonDays).fill(0)
          tgt.loadByDayByType=Object.fromEntries(TYPES.map(t=>[t,new Array(State.horizonDays).fill(0)]))
          const teKeys=Object.keys(tgt.quotaTE); tgt.loadByDayByTE=Object.fromEntries(teKeys.map(k=>[k,new Array(State.horizonDays).fill(0)]))
        })
      }
      State.shipDays=data.State?.shipDays||{}
      State.opDurTE=data.State?.opDurTE||{}
      State.demands=[]
      if(Array.isArray(data.State?.demands)){
        data.State.demands.forEach(d=>{
          const c=State.centres.find(x=>x.name===d.centre); if(!c) return
          const D={id:d.id, client:d.client, centre:c, centreName:c.name, engine:d.engine, type:d.type, priority:d.priority, duration:d.duration, startDate:new Date(d.startDate)}
          State.demands.push(D); placeDemandOnCalendar(D)
        })
      }
      rebuildCompatSummary(); hydrateUI(); buildHeatmapFor('c-centre-t1','heatmap-t1'); buildReqTable(); evaluateCurrent()
    }catch(e){ __toast('Import invalide : '+e.message) }
  }
  r.readAsText(file)
})

for(const id of ['f-centre','f-engine','f-type','f-prio','f-from','f-to']){
  document.getElementById(id).addEventListener('change', buildReqTable)
}

document.getElementById('btn-reset-f').addEventListener('click',()=>{
  document.getElementById('f-centre').value='All'
  document.getElementById('f-engine').value='All'
  document.getElementById('f-type').value='All'
  document.getElementById('f-prio').value='All'
  document.getElementById('f-from').valueAsDate=State.baseDate
  document.getElementById('f-to').valueAsDate=new Date(State.baseDate.getTime()+days(State.horizonDays-1))
  buildReqTable()
})

// Init
regenerate();
// Heatmap selector change
const selT1=document.getElementById('c-centre-t1'); if(selT1){ selT1.addEventListener('change', ()=>buildHeatmapFor('c-centre-t1','heatmap-t1')) }
</script>
</body>
</html>
