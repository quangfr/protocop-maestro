<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MAESTRO ‚Äî Prototype Fiori</title>
  <style>
    :root{
      --bg:#f6f7f9;/* fond doux Fiori-like */
      --card:#ffffff;
      --text:#1b1f24;
      --muted:#6b7280;
      --brand:#0a6ed1;/* SAP blue */
      --brand-2:#0854a0;
      --ok:#2ecc71; --warn:#f1c40f; --bad:#e74c3c;
      --chip:#eef2f7;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .app{display:flex;flex-direction:column;min-height:100vh;width:100vw;max-width:100vw;}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:10;background:var(--card);box-shadow:0 1px 0 var(--border);padding:12px 20px;display:flex;align-items:center;gap:16px}
    .brand{font-weight:700;letter-spacing:.2px}
    .pill{padding:4px 8px;border-radius:999px;background:var(--chip);color:var(--muted);font-size:12px}

    /* Tabs */
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{border:none;background:transparent;padding:10px 12px;border-radius:10px;cursor:pointer;color:var(--muted);font-weight:600}
    .tab.active{color:var(--card);background:var(--brand)}

    /* Content */
    .content{flex:1;display:flex;flex-direction:column;padding:14px;gap:14px;width:100%}

    /* Card */
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.02)}
    .card h3{margin:0 0 8px 0;font-size:16px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;width:100%}
    @media(max-width:1200px){.row{grid-template-columns:repeat(6,1fr)}}
    @media(max-width:800px){.row{grid-template-columns:repeat(2,1fr)}}

    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    select,input[type="number"],input[type="text"],input[type="date"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#fff}

    .btn{appearance:none;border:none;background:var(--brand);color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn.secondary{background:#e9eef6;color:#0a2540}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    .table{width:100%;border-collapse:separate;border-spacing:0;overflow:auto}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
    .table th{font-size:12px;color:var(--muted);font-weight:700}
    .badge{padding:3px 8px;border-radius:999px;background:var(--chip);font-size:12px}

    .grid{display:grid;gap:8px}
    .eta-grid{grid-template-columns: 220px 1fr 1fr 1.6fr}
    .eta-head{font-size:12px;color:var(--muted);font-weight:700}
    .eta-row{padding:8px;border-bottom:1px solid var(--border);display:contents}
    .eta-cell{padding:6px 8px}

    /* Highlights */
    .best-resp{background:#e8f5e9;border-radius:10px}
    .best-fast{background:#fffbe6;border-radius:10px}
    .red{color:var(--bad);font-weight:700}

    /* Heatmap */
    .heatmap{display:grid;grid-template-columns:220px repeat(12,1fr);gap:4px;align-items:stretch}
    .heat-head{font-size:12px;color:var(--muted)}
    .heat-row{display:contents}
    .heat-label{padding:6px 8px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .heat-cell{height:34px;border-radius:8px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px}

    .footer{padding:10px;color:var(--muted);text-align:center}

    .hint{font-size:12px;color:var(--muted)}
    .split{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media(max-width:1200px){.split{grid-template-columns:1fr}}

    /* Full-width helpers */
    .full-width{width:100%;max-width:100%}
  </style>
</head>
<body>
<div class="app">
  <div class="topbar full-width">
    <div class="brand">üõ†Ô∏è MAESTRO ‚Äî Maintenance ‚Ä¢ <span class="pill">Prototype Fiori</span></div>
    <div class="tabs" role="tablist" aria-label="Navigation des onglets">
      <button class="tab active" data-tab="t1">1) üì• Demande & Reco</button>
      <button class="tab" data-tab="t2">2) üß© Master Data</button>
      <button class="tab" data-tab="t3">3) üè≠ Centres ‚Ä¢ Heatmap</button>
      <button class="tab" data-tab="t4">4) üìÑ Demandes ‚Ä¢ Liste</button>
    </div>
  </div>

  <div class="content full-width">
    <!-- TAB 1 -->
    <section id="t1" class="card">
      <h3>üì• Saisie de la demande & recommandations (‚ö° FastETA ‚Ä¢ üçÄ ResponsibleETA)</h3>
      <div class="row" style="align-items:end">
        <div class="field col"><label>Client</label><select id="r-client"></select></div>
        <div class="field col"><label>Moteur</label><select id="r-engine"></select></div>
        <div class="field col"><label>Type de demande</label><select id="r-type"></select></div>
        <div class="field col"><label>Priorit√©</label>
          <select id="r-priority">
            <option value="Urgent">Urgent</option>
            <option value="Standard" selected>Standard</option>
          </select>
        </div>
        <div class="field col"><label>Date de mise √† disposition</label>
          <input id="r-available" type="date" />
        </div>
        <div class="field col">
          <button class="btn" id="btn-evaluate">√âvaluer</button>
        </div>
        <div class="field col">
          <button class="btn secondary" id="btn-add">Ajouter cette demande au planning</button>
          <span class="hint">Ajoute √† la charge & √† la heatmap</span>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="grid eta-grid">
          <div class="eta-head">Centre</div>
          <div class="eta-head">‚ö° FastETA (j)</div>
          <div class="eta-head">üçÄ ResponsibleETA (j)</div>
          <div class="eta-head">D√©tails</div>
          <div id="eta-rows" class="eta-body" style="display:contents"></div>
        </div>
        <div class="hint" id="eta-hint">Tri par üçÄ ResponsibleETA. R√©sultats bas√©s sur compatibilit√©s Centre √ó (Moteur, Type) et capacit√©s pr√©vues.</div>
      </div>
    </section>

    <!-- TAB 2 -->
    <section id="t2" class="card" hidden>
      <h3>üß© Master Data & Randomization</h3>
      <div class="split">
        <div class="card">
          <h3>Param√®tres globaux</h3>
          <div class="row">
            <div class="field"><label>Seed</label><input type="number" id="m-seed" value="42"/></div>
            <div class="field"><label>Horizon (semaines)</label><input type="number" id="m-weeks" value="12" min="4" max="26"/></div>
            <div class="field"><label>Clients (N)</label><input type="number" id="m-clients" value="30" min="1"/></div>
            <div class="field"><label>Demandes existantes (N)</label><input type="number" id="m-reqs" value="250" min="0"/></div>
            <div class="field"><label>% Urgent</label><input type="number" id="m-pUrgent" value="25" min="0" max="100"/></div>
          </div>
          <h3>Capacit√©s des centres</h3>
          <div class="row">
            <div class="field"><label>Slots/jour min</label><input type="number" id="m-capMin" value="4" min="1"/></div>
            <div class="field"><label>Slots/jour max</label><input type="number" id="m-capMax" value="10" min="1"/></div>
            <div class="field"><label>Tendance (%) min</label><input type="number" id="m-trendMin" value="-10"/></div>
            <div class="field"><label>Tendance (%) max</label><input type="number" id="m-trendMax" value="10"/></div>
          </div>
          <h3>Dur√©es par type (triangulaire, jours)</h3>
          <div class="row">
            <div class="field"><label>TestOnly (min,mode,max)</label><input type="text" id="m-dur-test" value="2,3,4"/></div>
            <div class="field"><label>QuickInspection</label><input type="text" id="m-dur-qi" value="3,4,6"/></div>
            <div class="field"><label>RepairOnly</label><input type="text" id="m-dur-rep" value="12,18,28"/></div>
            <div class="field"><label>Overhaul</label><input type="text" id="m-dur-ovh" value="35,45,65"/></div>
          </div>
          <h3>Acheminement (jours, poids pour 0..4)</h3>
          <div class="row">
            <div class="field"><label>Poids 0j</label><input type="number" id="m-w0" value="25"/></div>
            <div class="field"><label>Poids 1j</label><input type="number" id="m-w1" value="35"/></div>
            <div class="field"><label>Poids 2j</label><input type="number" id="m-w2" value="20"/></div>
            <div class="field"><label>Poids 3j</label><input type="number" id="m-w3" value="15"/></div>
            <div class="field"><label>Poids 4j</label><input type="number" id="m-w4" value="5"/></div>
          </div>
          <h3>R√®gles & p√©nalit√©</h3>
          <div class="row">
            <div class="field"><label>Capacit√© r√©serv√©e urgents (%)</label><input type="number" id="m-reserveUrg" value="25"/></div>
            <div class="field"><label>Facteur p√©nalit√© saturation</label><input type="number" id="m-penaltyFactor" value="1.0" step="0.1"/></div>
          </div>
          <div class="toolbar" style="margin-top:8px">
            <button class="btn" id="btn-regenerate">Reg√©n√©rer la donn√©e</button>
            <button class="btn ghost" id="btn-export">Export JSON</button>
            <input type="file" id="import-file" accept="application/json" hidden>
            <button class="btn ghost" id="btn-import">Import JSON</button>
          </div>
          <div class="hint">Modifiez les param√®tres puis cliquez sur ¬´ Reg√©n√©rer ¬ª pour recalculer capacit√©s, charges, ETA & heatmap.</div>
        </div>
        <div class="card">
          <h3>R√©sum√© des compatibilit√©s</h3>
          <table class="table" id="compat-table"></table>
        </div>
      </div>
    </section>

    <!-- TAB 3 -->
    <section id="t3" class="card" hidden>
      <h3>üè≠ Vue Centre ‚Üí Heatmap d'occupation (12 semaines)</h3>
      <div class="toolbar">
        <label class="field" style="min-width:240px">
          <span>Centre</span>
          <select id="c-centre"></select>
        </label>
      </div>
      <div class="card">
        <div class="heatmap" id="heatmap">
          <!-- header row -->
        </div>
        <div class="hint">Chaque cellule = taux d'occupation max de la semaine (0‚Äì150%). Survoler pour le d√©tail.</div>
      </div>
    </section>

    <!-- TAB 4 -->
    <section id="t4" class="card" hidden>
      <h3>üìÑ Toutes les demandes</h3>
      <div class="toolbar">
        <label>Centre <select id="f-centre"></select></label>
        <label>Moteur <select id="f-engine"></select></label>
        <label>Type <select id="f-type"></select></label>
        <label>Priorit√© <select id="f-prio"><option>All</option><option>Urgent</option><option selected>Standard</option></select></label>
        <label>De <input type="date" id="f-from"></label>
        <label>√Ä <input type="date" id="f-to"></label>
        <button class="btn ghost" id="btn-reset-f">R√©initialiser</button>
      </div>
      <div class="card">
        <table class="table" id="req-table"></table>
      </div>
    </section>
  </div>

  <div class="footer">Prototype HTML standalone ‚Ä¢ Fiori-like ‚Ä¢ largeur totale</div>
</div>

<script>
// ----------------------- Utilities -----------------------
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
let RNG = mulberry32(42);
function seedRng(s){RNG = mulberry32(Number(s)||42)}
function rand(){return RNG()}
function rInt(min,max){return Math.floor(rand()*(max-min+1))+min}
function choice(arr){return arr[Math.floor(rand()*arr.length)]}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(rand()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function clamp(v,min,max){return v<min?min:v>max?max:v}
function triangular(min,mode,max){const u=rand();const c=(mode-min)/(max-min);return u<c?min+Math.sqrt(u*(max-min)*(mode-min)):max-Math.sqrt((1-u)*(max-min)*(max-mode))}
function days(n){return n*24*60*60*1000}
function startOfToday(){const d=new Date();d.setHours(0,0,0,0);return d}

// ----------------------- Master Data -----------------------
const ENGINES=["LEAP-1A","LEAP-1B","CFM56-5B","CFM56-7B","SaM146"]
const TYPES=["Overhaul","RepairOnly","QuickInspection","TestOnly"]
const CITIES=["Paris","Lyon","Toulouse","Bordeaux","Nantes","Lille","Marseille","Nice","Strasbourg","Rennes","Grenoble","Montpellier","Clermont-F.","Rouen","Tours","Dijon","Nancy","Orl√©ans","Metz","Reims"]

const Params={
  seed:42,weeks:12,clients:30,existing:250,pUrgent:25,
  capMin:4,capMax:10,trendMin:-10,trendMax:10,
  durations:{TestOnly:[2,3,4],QuickInspection:[3,4,6],RepairOnly:[12,18,28],Overhaul:[35,45,65]},
  shipW:[25,35,20,15,5], // weights for 0..4 days
  reserveUrgPct:25,
  penaltyFactor:1.0
}

// Derived
let State={
  horizonDays:84, baseDate:startOfToday(),
  centres:[], customers:[], demands:[], // existing
  compatSummary:[],
  shipDays:{}, // client -> centre -> days (fixed)
  opDurTE:{} // type -> engine -> days (fixed)
}

// ----------------------- Generation -----------------------
function buildCentres(){
  const centres=[]
  for(let i=0;i<20;i++){
    const name=CITIES[i]
    const engines=shuffle([...ENGINES]).slice(0,rInt(2,3))
    const types=shuffle([...TYPES]).slice(0,rInt(2,3))
    const capBase=rInt(Params.capMin,Params.capMax)
    const trend= (rInt(Params.trendMin,Params.trendMax))/100
    // capacity per day over horizon with weekday factor + linear trend
    const capByDay=[]
    for(let d=0; d<State.horizonDays; d++){
      const date=new Date(State.baseDate.getTime()+days(d))
      const wd=date.getDay() // 0=Sun
      let factor=1
      if(wd===0) factor=clamp(0.5+rand()*0.1,0.4,0.6)
      else if(wd===6) factor=clamp(0.6+rand()*0.2,0.6,0.8)
      else if(wd===5) factor=clamp(0.8+rand()*0.2,0.8,1.0)
      else factor=clamp(0.9+rand()*0.2,0.9,1.1)
      const drift=1 + trend * (d/(State.horizonDays-1))
      capByDay.push(Math.max(1, Math.round(capBase*factor*drift)))
    }
    centres.push({id:i,name,engines:new Set(engines),types:new Set(types),capBase,trend,capByDay,loadByDay: new Array(State.horizonDays).fill(0),
      loadByDayByType: Object.fromEntries(TYPES.map(t=>[t,new Array(State.horizonDays).fill(0)]))})
  }
  State.centres=centres
}

function buildCustomers(){
  State.customers = Array.from({length:Params.clients},(_,i)=>`Client-${String(i+1).padStart(3,'0')}`)
}

function sampleShipDays(){
  const w=Params.shipW; const sum=w.reduce((a,b)=>a+b,0); let x=rand()*sum; let s=0
  for(let i=0;i<w.length;i++){ s+=w[i]; if(x<=s) return i }
  return 4
}

function buildShipMatrix(){
  const ship={}
  for(const cl of State.customers){
    ship[cl]={}
    for(const c of State.centres){ ship[cl][c.name]=sampleShipDays() }
  }
  State.shipDays=ship
}

function buildOpDurTE(){
  const table={}
  for(const t of TYPES){
    table[t]={}
    const [min,mode,max]=Params.durations[t]
    for(const e of ENGINES){
      table[t][e]=Math.round(triangular(min,mode,max))
    }
  }
  State.opDurTE=table
}

function pickCompatibleCentre(type,engine){
  const eligible=State.centres.filter(c=>c.types.has(type)&&c.engines.has(engine))
  if(eligible.length===0) return null
  // prefer centres with lower average load ratio today
  const scored=eligible.map(c=>{
    const cap=c.capByDay[0]||1; const load=c.loadByDay[0]||0; const util=load/cap
    return {c, score: util + rand()*0.1}
  }).sort((a,b)=>a.score-b.score)
  return scored[0].c
}

function placeDemandOnCalendar(demand){
  // occupy 1 slot/day for 'duration' days from start
  const c=demand.centre
  const startIdx = Math.max(0, Math.floor((demand.startDate - State.baseDate)/days(1)))
  for(let d=0; d<demand.duration; d++){
    const idx=startIdx+d
    if(idx>=0 && idx<State.horizonDays){
      c.loadByDay[idx] += 1
      c.loadByDayByType[demand.type][idx] += 1
    }
  }
}

function buildExistingDemands(){
  State.demands=[]
  for(let i=0;i<Params.existing;i++){
    const type=choice(TYPES)
    const centre=choice(State.centres.filter(c=>c.types.has(type)))
    if(!centre) continue
    const engine=choice([...centre.engines])
    const priority = rand()*100 < Params.pUrgent ? 'Urgent' : 'Standard'
    const duration=State.opDurTE[type][engine]
    const startOffset = rInt(0, State.horizonDays-1)
    const startDate = new Date(State.baseDate.getTime()+days(startOffset))
    const d={id:`E${i+1}`, client: choice(State.customers), centre, centreName: centre.name, engine, type, priority, duration, startDate}
    State.demands.push(d)
    placeDemandOnCalendar(d)
  }
}

function rebuildCompatSummary(){
  State.compatSummary = State.centres.map(c=>({
    centre:c.name,
    moteurs:[...c.engines].join(', '),
    types:[...c.types].join(', '),
    capBase:c.capBase
  }))
}

function regenerate(){
  seedRng(Params.seed)
  State.baseDate=startOfToday()
  State.horizonDays=Params.weeks*7
  buildCentres()
  buildCustomers()
  buildShipMatrix()
  buildOpDurTE()
  buildExistingDemands()
  rebuildCompatSummary()
  hydrateUI()
  evaluateCurrent() // refresh eta table if inputs set
  buildHeatmap()
  buildReqTable()
}

// ----------------------- ETA calculation -----------------------
function avgDurationByType(type){
  const [min,mode,max]=Params.durations[type]
  return Math.round((min+mode+max)/3)
}

function occAtWeek4(centre,type){
  const week=4; // 1-based week index
  const start=(week-1)*7; const end=start+7
  let maxOcc=0
  for(let i=start;i<end && i<State.horizonDays;i++){
    const cap=centre.capByDay[i]||1
    const loadType=centre.loadByDayByType[type]?.[i]||0
    const occ = loadType / cap
    if(occ>maxOcc) maxOcc=occ
  }
  return maxOcc // e.g., 1.25 means 125%
}

function computePenaltyDays(centre,type){
  const occ=occAtWeek4(centre,type)
  const excess = Math.max(0, occ - 1)
  const avgDays = avgDurationByType(type)
  return Math.round(Params.penaltyFactor * excess * avgDays)
}

function waitDaysIfFull(centre, priority){
  // if next week >100% and Standard, add wait; urgent bypass (<= Standard guaranteed)
  const week=1
  const start=(week-1)*7; const end=start+7
  let maxOcc=0
  for(let i=start;i<end && i<State.horizonDays;i++){
    const cap=centre.capByDay[i]||1
    const load=centre.loadByDay[i]||0
    const occ=load/cap; if(occ>maxOcc) maxOcc=occ
  }
  if(priority==='Urgent') return 0
  if(maxOcc<=1) return 0
  return Math.ceil((maxOcc-1)*7)
}

function evaluateRequest(req){
  const {client,engine,type,priority} = req
  const eligible=State.centres.filter(c=>c.engines.has(engine)&&c.types.has(type))
  const rows=[]
  for(const c of eligible){
    const ship = (State.shipDays[client] && State.shipDays[client][c.name]!==undefined) ? State.shipDays[client][c.name] : 0
    const shipOut=ship, shipBack=ship // fixe & sym√©trique
    const dur=State.opDurTE[type][engine]
    const baseETA=shipOut + dur + shipBack
    const wait=waitDaysIfFull(c, priority)
    const fast=baseETA + wait
    const penalty=computePenaltyDays(c,type)
    const responsible=fast + penalty
    rows.push({centre:c,fast,responsible,shipOut,shipBack,dur,wait,penalty,
      detailHTML:`Aller ${shipOut}j ‚Ä¢ Ops ${dur}j ‚Ä¢ Attente <span class='${wait>0?"red":""}'>${wait}</span>j ‚Ä¢ Retour ${shipBack}j ‚Ä¢ P√©nalit√© <span class='${penalty>0?"red":""}'>${penalty}</span>j`})
  }
  // bests
  const bestFast = rows.length ? rows.reduce((p,c)=> c.fast<p.fast?c:p, rows[0]) : null
  const bestResp = rows.length ? rows.reduce((p,c)=> c.responsible<p.responsible?c:p, rows[0]) : null
  // sort by ResponsibleETA ascending
  rows.sort((a,b)=>a.responsible-b.responsible)
  return {rows,bestFast,bestResp}
}

// ----------------------- UI Binding -----------------------
function hydrateSelectors(){
  const elC=document.getElementById('r-client'); elC.innerHTML=State.customers.map(c=>`<option>${c}</option>`).join('')
  const elE=document.getElementById('r-engine'); elE.innerHTML=ENGINES.map(e=>`<option>${e}</option>`).join('')
  const elT=document.getElementById('r-type'); elT.innerHTML=TYPES.map(t=>`<option>${t}</option>`).join('')
  // defaults
  document.getElementById('r-available').valueAsDate=State.baseDate

  // filters tab4
  const fC=document.getElementById('f-centre'); fC.innerHTML=['All',...State.centres.map(c=>c.name)].map(c=>`<option>${c}</option>`).join('')
  const fE=document.getElementById('f-engine'); fE.innerHTML=['All',...ENGINES].map(e=>`<option>${e}</option>`).join('')
  const fT=document.getElementById('f-type'); fT.innerHTML=['All',...TYPES].map(t=>`<option>${t}</option>`).join('')
  document.getElementById('f-from').valueAsDate=State.baseDate
  const to=new Date(State.baseDate.getTime()+days(State.horizonDays-1)); document.getElementById('f-to').valueAsDate=to

  // centres for heatmap
  const cSelect=document.getElementById('c-centre'); cSelect.innerHTML=State.centres.map(c=>`<option>${c.name}</option>`).join('')
}

function hydrateCompatTable(){
  const tbl=document.getElementById('compat-table')
  tbl.innerHTML=`<thead><tr><th>Centre</th><th>Moteurs</th><th>Types</th><th>Cap. base</th></tr></thead>`+
    '<tbody>'+State.compatSummary.map(r=>`<tr><td>${r.centre}</td><td>${r.moteurs}</td><td>${r.types}</td><td>${r.capBase}</td></tr>`).join('')+'</tbody>'
}

function evaluateCurrent(){
  const req={
    client: document.getElementById('r-client').value,
    engine: document.getElementById('r-engine').value,
    type: document.getElementById('r-type').value,
    priority: document.getElementById('r-priority').value,
    available: document.getElementById('r-available').valueAsDate
  }
  const res=evaluateRequest(req)
  const body=document.getElementById('eta-rows'); body.innerHTML=''
  res.rows.forEach(r=>{
    const isFastReco = res.bestFast && r.centre===res.bestFast.centre
    const isRespReco = res.bestResp && r.centre===res.bestResp.centre
    const redFlag = (r.wait>0 || r.penalty>0)
    body.insertAdjacentHTML('beforeend',`
      <div class="eta-row">
        <div class="eta-cell ${isRespReco?"best-resp":(isFastReco?"best-fast":"")}"><strong>${r.centre.name}</strong></div>
        <div class="eta-cell ${(isFastReco?"best-fast":"")} ${redFlag?"red":""}">${r.fast}</div>
        <div class="eta-cell ${(isRespReco?"best-resp":"")} ${redFlag?"red":""}">${r.responsible}</div>
        <div class="eta-cell hint">${r.detailHTML}</div>
      </div>`)
  })
  const hint=document.getElementById('eta-hint')
  if(res.bestFast||res.bestResp){
    const bestF=res.bestFast? res.bestFast.centre.name+` (${res.bestFast.fast}j ‚ö°)` : '‚Äî'
    const bestR=res.bestResp? res.bestResp.centre.name+` (${res.bestResp.responsible}j üçÄ)` : '‚Äî'
    hint.textContent = `Tri: üçÄ ResponsibleETA ‚Ä¢ Reco ‚ö°: ${bestF} ‚Ä¢ Reco üçÄ: ${bestR}`
  }
}

function buildHeatmap(){
  const grid=document.getElementById('heatmap')
  grid.innerHTML=''
  // header
  grid.insertAdjacentHTML('beforeend', `<div></div>${Array.from({length:Params.weeks},(_,i)=>`<div class='heat-head' style='text-align:center'>S${i+1}</div>`).join('')}`)
  const centreName=document.getElementById('c-centre').value || State.centres[0]?.name
  const centre=State.centres.find(c=>c.name===centreName) || State.centres[0]
  // rows = type√óengine combos supported
  const rows=[]
  for(const t of TYPES){
    for(const e of ENGINES){
      if(centre.types.has(t) && centre.engines.has(e)) rows.push({label:`${t} √ó ${e}`, type:t, engine:e})
    }
  }
  if(rows.length===0){ grid.insertAdjacentHTML('beforeend', `<div class='heat-label'>Aucune compatibilit√©</div>`); return }
  // For occupancy by type we ignore engine granularity in generation; to approximate, split type load equally across supported engines
  const supportedEngines=[...centre.engines]
  const typeShare=Object.fromEntries(TYPES.map(t=>[t, Math.max(1,supportedEngines.length)]))

  for(const r of rows){
    grid.insertAdjacentHTML('beforeend', `<div class='heat-label'>${r.label}</div>`)
    for(let w=0;w<Params.weeks;w++){
      let maxOcc=0
      for(let i=w*7;i<Math.min(State.horizonDays,(w+1)*7);i++){
        const cap=centre.capByDay[i]||1
        const loadType = (centre.loadByDayByType[r.type]?.[i]||0) / typeShare[r.type]
        const occ = loadType / cap
        if(occ>maxOcc) maxOcc=occ
      }
      const pct = clamp(maxOcc,0,1.5) // cap √† 150%
      const color = heatColor(pct)
      const label = Math.round(pct*100)+"%"
      grid.insertAdjacentHTML('beforeend', `<div class='heat-cell' title='Semaine ${w+1} ‚Ä¢ Occ: ${label}' style='background:${color}'>${label}</div>`)
    }
  }
}

function heatColor(p){
  // 0 -> #e8f5e9 (vert p√¢le), 1 -> #f39c12 (orange), 1.5 -> #e74c3c (rouge)
  if(p<=0.5){ // 0..50%
    return `linear-gradient(0deg, rgba(232,245,233,1) 0%, rgba(214,239,220,1) 100%)`
  }else if(p<=1){
    return `linear-gradient(0deg, rgba(255,249,230,1) 0%, rgba(255,236,179,1) 100%)`
  }else{
    return `linear-gradient(0deg, rgba(255,235,230,1) 0%, rgba(231,76,60,0.25) 100%)`
  }
}

function buildReqTable(){
  const tbl=document.getElementById('req-table')
  const centre=document.getElementById('f-centre').value
  const engine=document.getElementById('f-engine').value
  const type=document.getElementById('f-type').value
  const prio=document.getElementById('f-prio').value
  const from=document.getElementById('f-from').valueAsDate
  const to=document.getElementById('f-to').valueAsDate

  const rows=State.demands.filter(d=>{
    if(centre && centre!=='All' && d.centreName!==centre) return false
    if(engine && engine!=='All' && d.engine!==engine) return false
    if(type && type!=='All' && d.type!==type) return false
    if(prio && prio!=='All' && d.priority!==prio) return false
    if(from && d.startDate<from) return false
    if(to){ const dt=new Date(to.getTime()); dt.setHours(23,59,59,999); if(d.startDate>dt) return false }
    return true
  })
  rows.sort((a,b)=>a.startDate-b.startDate)
  const head=`<thead><tr>
    <th>#</th><th>Client</th><th>Centre</th><th>Moteur</th><th>Type</th><th>Priorit√©</th><th>D√©but</th><th>Dur√©e (j)</th></tr></thead>`
  const body='<tbody>'+rows.map(r=>`<tr><td>${r.id}</td><td>${r.client}</td><td>${r.centreName}</td><td>${r.engine}</td><td>${r.type}</td><td><span class='badge'>${r.priority}</span></td><td>${r.startDate.toISOString().slice(0,10)}</td><td>${r.duration}</td></tr>`).join('')+'</tbody>'
  tbl.innerHTML=head+body
}

function addCurrentRequest(){
  // place currently set request into dataset
  const type=document.getElementById('r-type').value
  const engine=document.getElementById('r-engine').value
  let centreNameBest = null
  const rows=document.querySelectorAll('#eta-rows .eta-row')
  if(rows.length){
    // first row is best ResponsibleETA due to sorting
    centreNameBest = rows[0].querySelector('.eta-cell strong')?.textContent || null
  }
  let centre = State.centres.find(c=>c.name===centreNameBest && c.types.has(type) && c.engines.has(engine))
  if(!centre){ centre = pickCompatibleCentre(type, engine) }
  if(!centre){ alert('Aucun centre compatible pour cette demande.'); return }
  const client=document.getElementById('r-client').value
  const priority=document.getElementById('r-priority').value
  const startDate=document.getElementById('r-available').valueAsDate || State.baseDate
  const duration=State.opDurTE[type][engine]
  const id=`N${State.demands.length+1}`
  const d={id, client, centre, centreName:centre.name, engine, type, priority, duration, startDate}
  State.demands.push(d)
  placeDemandOnCalendar(d)
  buildHeatmap(); buildReqTable(); evaluateCurrent()
}

function hydrateUI(){
  hydrateSelectors(); hydrateCompatTable()
}

// ----------------------- Events -----------------------
// Tabs
for(const b of document.querySelectorAll('.tab')){
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'))
    b.classList.add('active')
    const id=b.dataset.tab
    document.querySelectorAll('section.card').forEach(s=>s.hidden = s.id!==id)
    if(id==='t3') buildHeatmap()
    if(id==='t4') buildReqTable()
  })
}

// Evaluate & Add
document.getElementById('btn-evaluate').addEventListener('click', evaluateCurrent)
for(const id of ['r-client','r-engine','r-type','r-priority','r-available']){
  document.getElementById(id).addEventListener('change', evaluateCurrent)
}

document.getElementById('btn-add').addEventListener('click', addCurrentRequest)

// Master data
function parseTriple(txt){return txt.split(',').map(x=>Number(x.trim()))}

document.getElementById('btn-regenerate').addEventListener('click',()=>{
  Params.seed = Number(document.getElementById('m-seed').value)
  Params.weeks = Number(document.getElementById('m-weeks').value)
  Params.clients = Number(document.getElementById('m-clients').value)
  Params.existing = Number(document.getElementById('m-reqs').value)
  Params.pUrgent = Number(document.getElementById('m-pUrgent').value)
  Params.capMin = Number(document.getElementById('m-capMin').value)
  Params.capMax = Number(document.getElementById('m-capMax').value)
  Params.trendMin = Number(document.getElementById('m-trendMin').value)
  Params.trendMax = Number(document.getElementById('m-trendMax').value)
  Params.durations.TestOnly = parseTriple(document.getElementById('m-dur-test').value)
  Params.durations.QuickInspection = parseTriple(document.getElementById('m-dur-qi').value)
  Params.durations.RepairOnly = parseTriple(document.getElementById('m-dur-rep').value)
  Params.durations.Overhaul = parseTriple(document.getElementById('m-dur-ovh').value)
  Params.shipW=[0,1,2,3,4].map(i=>Number(document.getElementById('m-w'+i).value))
  Params.reserveUrgPct = Number(document.getElementById('m-reserveUrg').value)
  Params.penaltyFactor = Number(document.getElementById('m-penaltyFactor').value)
  regenerate()
})

document.getElementById('c-centre').addEventListener('change', buildHeatmap)

// Export/Import
function download(filename, text){
  const a=document.createElement('a')
  a.setAttribute('href','data:application/json;charset=utf-8,'+encodeURIComponent(text))
  a.setAttribute('download',filename)
  a.style.display='none'; document.body.appendChild(a); a.click(); document.body.removeChild(a)
}

document.getElementById('btn-export').addEventListener('click',()=>{
  const out={Params, State: {
    baseDate: State.baseDate.toISOString().slice(0,10),
    horizonDays: State.horizonDays,
    centres: State.centres.map(c=>({name:c.name, engines:[...c.engines], types:[...c.types], capBase:c.capBase, trend:c.trend, capByDay:c.capByDay})),
    demands: State.demands.map(d=>({id:d.id, client:d.client, centre:d.centreName, engine:d.engine, type:d.type, priority:d.priority, duration:d.duration, startDate:d.startDate.toISOString().slice(0,10)})),
    shipDays: State.shipDays,
    opDurTE: State.opDurTE
  }}
  download('maestro_dataset.json', JSON.stringify(out,null,2))
})

document.getElementById('btn-import').addEventListener('click',()=>document.getElementById('import-file').click())

document.getElementById('import-file').addEventListener('change',evt=>{
  const file=evt.target.files[0]; if(!file) return
  const r=new FileReader(); r.onload=()=>{
    try{
      const data=JSON.parse(r.result)
      Object.assign(Params, data.Params||{})
      // rebuild State from import (simple)
      State.baseDate = new Date((data.State?.baseDate)||startOfToday())
      State.horizonDays = data.State?.horizonDays || Params.weeks*7
      seedRng(Params.seed)
      buildCentres(); buildCustomers();
      // override centres from file when possible
      if(Array.isArray(data.State?.centres)){
        data.State.centres.slice(0,20).forEach((c,i)=>{
          const target=State.centres[i];
          target.name=c.name; target.engines=new Set(c.engines||[]); target.types=new Set(c.types||[]);
          target.capBase=c.capBase||target.capBase; target.trend=c.trend||target.trend; target.capByDay=c.capByDay||target.capByDay
          target.loadByDay=new Array(State.horizonDays).fill(0); target.loadByDayByType=Object.fromEntries(TYPES.map(t=>[t,new Array(State.horizonDays).fill(0)]))
        })
      }
      State.shipDays = data.State?.shipDays || {}
      State.opDurTE = data.State?.opDurTE || {}
      State.demands=[]
      if(Array.isArray(data.State?.demands)){
        data.State.demands.forEach(d=>{
          const centre=State.centres.find(c=>c.name===d.centre)
          if(!centre) return
          const demand={id:d.id, client:d.client, centre, centreName:centre.name, engine:d.engine, type:d.type, priority:d.priority, duration:d.duration, startDate:new Date(d.startDate)}
          State.demands.push(demand); placeDemandOnCalendar(demand)
        })
      }
      rebuildCompatSummary(); hydrateUI(); hydrateCompatTable(); buildHeatmap(); buildReqTable(); evaluateCurrent()
    }catch(e){ alert('Import invalide : '+e.message) }
  }
  r.readAsText(file)
})

// Filters in tab4
for(const id of ['f-centre','f-engine','f-type','f-prio','f-from','f-to']){
  document.getElementById(id).addEventListener('change', buildReqTable)
}

document.getElementById('btn-reset-f').addEventListener('click',()=>{
  document.getElementById('f-centre').value='All'
  document.getElementById('f-engine').value='All'
  document.getElementById('f-type').value='All'
  document.getElementById('f-prio').value='All'
  document.getElementById('f-from').valueAsDate=State.baseDate
  document.getElementById('f-to').valueAsDate=new Date(State.baseDate.getTime()+days(State.horizonDays-1))
  buildReqTable()
})

// ----------------------- Init -----------------------
regenerate()
</script>
</body>
</html>
